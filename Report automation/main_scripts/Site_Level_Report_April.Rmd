---
title: "Site Level Report"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: html_document
params:
  site_name: "Site A"            # Generic site name
  data_date: "2024-03-31"
  include_Attendance: FALSE
  include_Blood_test: FALSE
  include_HIV_test: FALSE
  include_HCV_test: FALSE
  include_HBV_test: FALSE
  include_HCV_diagnosis: FALSE
  include_HBV_diagnosis: FALSE
  include_HIV_diagnosis: FALSE
  site_code: ""
---
  
  
```{r setup, include=FALSE}

# Set global chunk options
knitr::opts_chunk$set(
  echo = FALSE,
  error = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 14,
  fig.height = 16,
  fig.topcaption = TRUE
)

# Ensure the "pacman" package is installed
if (!require("pacman")) {
  install.packages("pacman")
}

# Load necessary packages
pacman::p_load(
  rio,
  here,
  skimr,
  janitor,
  lubridate,
  epikit,
  tidyverse,
  flextable,
  scales,
  gtsummary,
  arrow,
  ggplot2,
  rlang,
  readxl,
  writexl,
  DBI,
  odbc,
  purrr,
  rmarkdown
)

# Define a generic color palette
generic_palette <- c("#00A5DF", "#007C91", "#1D57A5")

```



``` {r establish-connections}
# Establish a generic ODBC connection (replace with your own credentials and DSN)
db_connection <- odbc::dbConnect(odbc::odbc(),
                        .connection_string = "driver={SQL Server};server=YOUR_SERVER;database=YOUR_DB;Encrypt=true;trusted_connection=true",
                        timeout = 300,
                        timezone = Sys.timezone(),
                        timezone_out = Sys.timezone())

```


``` {r load-data-source-code}
# Load all helper functions stored in scripts (ensure the folder 'report_functions' exists in your working directory)
walk(
  list.files(here("reports", "functions"), pattern = "\\.R$", full.names = TRUE),
  source
)
```





``` {r load-data}
# Load site code based on the provided site name from a generic lookup list (assumed preloaded in 'site_codes_generic')
site_code <- site_codes_generic[[params$site_name]]
if (is.null(site_code) || site_code == "") {
  stop("Site code is not available for the site name provided: ", params$site_name)
}

# Load and clean attendees data for the viruses using generic helper functions
attendees_V1 <- load_attendees_data(db_connection, site_code, "Virus1")
attendees_V2 <- load_attendees_data(db_connection, site_code, "Virus2")
attendees_V3 <- load_attendees_data(db_connection, site_code, "Virus3")

attendees_V1_clean <- clean_data(attendees_V1)
attendees_V2_clean <- clean_data(attendees_V2)
attendees_V3_clean <- clean_data(attendees_V3)

# Create empty data frames if data are missing
if (is.null(attendees_V1_clean)) attendees_V1_clean <- data.frame()
if (is.null(attendees_V2_clean)) attendees_V2_clean <- data.frame()
if (is.null(attendees_V3_clean)) attendees_V3_clean <- data.frame()

```


``` {r alternate-data-loading-all-sites}

# Load data across all sites for each virus type
attendees_V1_all <- load_all_ed_data(db_connection, "Virus1")
attendees_V2_all <- load_all_ed_data(db_connection, "Virus2")
attendees_V3_all <- load_all_ed_data(db_connection, "Virus3")

# Clean the overall datasets
attendees_V1_all_clean <- clean_data(attendees_V1_all)
attendees_V2_all_clean <- clean_data(attendees_V2_all)
attendees_V3_all_clean <- clean_data(attendees_V3_all)


```


```{r attendees-analysis}
# Analyse characteristics for Virus1 attendees using a generic function
attendees_characteristics_V1 <- attendees_characteristics(attendees_V1_clean)

```


```{r overall-ED-attendees}

# Function to calculate total attendees for a given dataset
calculate_totals <- function(data, virus_type) {
  total_count <- if (!is.null(data) && nrow(data) > 0) nrow(data) else 0
  data.frame(
    Virus = virus_type,
    Total_Attendees_All_Sites = total_count,
    stringsAsFactors = FALSE
  )
}

# Generate totals for each virus type
totals_V1 <- calculate_totals(attendees_V1_all_clean, "Virus1")
totals_V2 <- calculate_totals(attendees_V2_all_clean, "Virus2")
totals_V3 <- calculate_totals(attendees_V3_all_clean, "Virus3")

# Overall characteristics for each virus type
overall_characteristics_V1 <- attendees_characteristics(attendees_V1_all_clean)
overall_characteristics_V2 <- attendees_characteristics(attendees_V2_all_clean)
overall_characteristics_V3 <- attendees_characteristics(attendees_V3_all_clean)


```


```{r overall-blood-test-prop}
# Calculate overall proportions tested across demographics for Virus1 using a generic helper
prop_tested_age_V1 <- calculate_proportion_tested(attendees_V1_all_clean, "age_group")
prop_tested_gender_V1 <- calculate_proportion_tested(attendees_V1_all_clean, "Gender")
prop_tested_ethnicity_V1 <- calculate_proportion_tested(attendees_V1_all_clean, "ethnic_group")
prop_tested_IMD_V1 <- calculate_proportion_tested(attendees_V1_all_clean, "IMD")

# Combine proportions for Virus1
overall_proportions_V1 <- bind_rows(
  mutate(prop_tested_age_V1, Demographic = "Age Group"),
  mutate(prop_tested_gender_V1, Demographic = "Gender"),
  mutate(prop_tested_ethnicity_V1, Demographic = "Ethnic Group"),
  mutate(prop_tested_IMD_V1, Demographic = "IMD")
)

# Repeat similar steps for Virus2 and Virus3 as needed...

```


```{r overall-prop-eligible-attendees}
# For Virus1: Calculate eligible attendees breakdown by demographics and their testing proportions
eligible_demo_age_V1 <- calculate_eligible_tested(attendees_V1_all_clean, age_group, "Virus1")
eligible_demo_gender_V1 <- calculate_eligible_tested(attendees_V1_all_clean, Gender, "Virus1")
eligible_demo_ethnicity_V1 <- calculate_eligible_tested(attendees_V1_all_clean, ethnic_group, "Virus1")
eligible_demo_IMD_V1 <- calculate_eligible_tested(attendees_V1_all_clean, IMD, "Virus1")

overall_combined_eligible_V1 <- bind_rows(
  mutate(eligible_demo_age_V1, Demographic = "Age Group"),
  mutate(eligible_demo_gender_V1, Demographic = "Gender"),
  mutate(eligible_demo_ethnicity_V1, Demographic = "Ethnic Group"),
  mutate(eligible_demo_IMD_V1, Demographic = "IMD")
)

prop_eligible_age_V1 <- proportion_tested_eligible(attendees_V1_all_clean, Virus1, age_group)
prop_eligible_gender_V1 <- proportion_tested_eligible(attendees_V1_all_clean, Virus1, Gender)
prop_eligible_ethnicity_V1 <- proportion_tested_eligible(attendees_V1_all_clean, Virus1, ethnic_group)
prop_eligible_IMD_V1 <- proportion_tested_eligible(attendees_V1_all_clean, Virus1, IMD)

combined_prop_eligible_V1 <- combine_and_prepare_eligible(
  list(prop_eligible_gender_V1, prop_eligible_age_V1, prop_eligible_ethnicity_V1, prop_eligible_IMD_V1),
  c("Gender", "Age Group", "Ethnic Group", "IMD")
)

# Similar processing can be repeated for Virus2 and Virus3 if required.

```


``` {r include-overall-HIV-diagnosis}
# Example for diagnosis proportions for Virus1

# Define helper to check if data frames in a list are empty
all_empty <- function(df_list) {
  all(sapply(df_list, function(df) nrow(df) == 0))
}

prop_diag_age_V1 <- proportion_diagnosed_V1(attendees_V1_all_clean, "age_group") %>% mutate(Demographic = "Age Group")
prop_diag_gender_V1 <- proportion_diagnosed_V1(attendees_V1_all_clean, "Gender") %>% mutate(Demographic = "Gender")
prop_diag_ethnic_V1 <- proportion_diagnosed_V1(attendees_V1_all_clean, "ethnic_group") %>% mutate(Demographic = "Ethnic Group")
prop_diag_IMD_V1 <- proportion_diagnosed_V1(attendees_V1_all_clean, "IMD") %>% mutate(Demographic = "IMD")

prop_diag_list_V1 <- list(prop_diag_age_V1, prop_diag_gender_V1, prop_diag_ethnic_V1, prop_diag_IMD_V1)

if (length(prop_diag_list_V1) == 0 || all_empty(prop_diag_list_V1)) {
  combined_diag_V1 <- data.frame()
} else {
  combined_diag_V1 <- bind_rows(prop_diag_list_V1) %>%
    select(Demographic, Category_Value, Proportion = Proportion_Tested) %>%
    filter(!(Category_Value %in% c("Unknown Gender", "Unknown Ethnicity", "Other", "Unknown IMD")))
}

# Similarly, count new and previous diagnoses if columns exist
if ("new_diagnosis" %in% colnames(attendees_V1_all_clean) && nrow(attendees_V1_all_clean) > 0) {
  new_diag_V1 <- attendees_V1_all_clean %>% filter(new_diagnosis == "TRUE")
  new_diag_V1_long <- if (nrow(new_diag_V1) > 0) count_new_diag(new_diag_V1) else data.frame()
}

if ("not_retained" %in% colnames(attendees_V1_all_clean) && nrow(attendees_V1_all_clean) > 0) {
  prev_diag_V1 <- attendees_V1_all_clean %>% filter(not_retained == "TRUE")
  prev_diag_V1_long <- if (nrow(prev_diag_V1) > 0) count_new_diag(prev_diag_V1) else data.frame()
}

```


``` {r include-overall-HCV-diagnosis}
# Define a function to check if all data frames in a list are empty
all_empty <- function(df_list) {
  all(sapply(df_list, function(df) nrow(df) == 0))
}

# Calculate proportions diagnosed with Virus3 across different demographics for overall distribution
overall_proportion_diagnosed_V3_age <- proportion_diagnosed_V3(attendees_V3_all_clean, "age_group") %>% mutate(Demographic = "Age Group")
overall_proportion_diagnosed_V3_gender <- proportion_diagnosed_V3(attendees_V3_all_clean, "Gender") %>% mutate(Demographic = "Gender")
overall_proportion_diagnosed_V3_ethnic <- proportion_diagnosed_V3(attendees_V3_all_clean, "ethnic_group") %>% mutate(Demographic = "Ethnic Group")
overall_proportion_diagnosed_V3_IMD <- proportion_diagnosed_V3(attendees_V3_all_clean, "IMD") %>% mutate(Demographic = "IMD")

# Combine the individual data frames into a list
overall_proportion_diagnosed_list_V3 <- list(
  overall_proportion_diagnosed_V3_age,
  overall_proportion_diagnosed_V3_gender,
  overall_proportion_diagnosed_V3_ethnic,
  overall_proportion_diagnosed_V3_IMD
)

# Check if the list of data frames is empty or if all data frames inside are empty
if (length(overall_proportion_diagnosed_list_V3) == 0 || all_empty(overall_proportion_diagnosed_list_V3)) {
  overall_combined_Proportion_diagnosed_long_V3 <- data.frame()
} else {
  # Proceed with combining data frames and further processing
  overall_combined_Proportion_diagnosed_long_V3 <- bind_rows(overall_proportion_diagnosed_list_V3) %>%
    select(Demographic, Category_Value, Proportion = Proportion_Tested) %>%
    filter(!(Category_Value %in% c("Unknown Gender", "Unknown Ethnicity", "Other", "Unknown IMD")))
}

# Check if the required column exists and the data frame is not empty
if ("new_positive_flag" %in% colnames(attendees_V3_all_clean) && nrow(attendees_V3_all_clean) > 0) {
  
  # Filter for newly diagnosed Virus3 cases
  overall_attendees_V3_new_diag <- attendees_V3_all_clean %>% filter(new_positive_flag == "New")
  
  if (nrow(overall_attendees_V3_new_diag) > 0) {
    # Count newly diagnosed Virus3 cases if any cases exist
    overall_attendees_V3_new_diag_long <- count_new_diag(overall_attendees_V3_new_diag)
  } else {
    # If no newly diagnosed cases, return an empty data frame
    overall_attendees_V3_new_diag_long <- data.frame()
  }
  
} else {
  # If the column doesn't exist or the data frame is empty, return an empty data frame
  overall_attendees_V3_new_diag_long <- data.frame()
}

```



``` {r include-overall-HBV-diagnosis}
# Define a function to check if all data frames in a list are empty
all_empty <- function(df_list) {
  all(sapply(df_list, function(df) nrow(df) == 0))
}

# Calculate proportions diagnosed with Virus2 across different demographics for overall distribution
overall_proportion_diagnosed_V2_age <- proportion_diagnosed_V2(attendees_V2_all_clean, "age_group") %>% mutate(Demographic = "Age Group")
overall_proportion_diagnosed_V2_gender <- proportion_diagnosed_V2(attendees_V2_all_clean, "Gender") %>% mutate(Demographic = "Gender")
overall_proportion_diagnosed_V2_ethnic <- proportion_diagnosed_V2(attendees_V2_all_clean, "ethnic_group") %>% mutate(Demographic = "Ethnic Group")
overall_proportion_diagnosed_V2_IMD <- proportion_diagnosed_V2(attendees_V2_all_clean, "IMD") %>% mutate(Demographic = "IMD")

# Combine the individual data frames into a list
overall_proportion_diagnosed_list_V2 <- list(
  overall_proportion_diagnosed_V2_age,
  overall_proportion_diagnosed_V2_gender,
  overall_proportion_diagnosed_V2_ethnic,
  overall_proportion_diagnosed_V2_IMD
)

# Check if the list of data frames is empty or if all data frames inside are empty
if (length(overall_proportion_diagnosed_list_V2) == 0 || all_empty(overall_proportion_diagnosed_list_V2)) {
  overall_combined_Proportion_diagnosed_long_V2 <- data.frame()
} else {
  # Proceed with combining data frames and further processing
  overall_combined_Proportion_diagnosed_long_V2 <- bind_rows(overall_proportion_diagnosed_list_V2) %>%
    select(Demographic, Category_Value, Proportion = Proportion_Tested) %>%
    filter(!(Category_Value %in% c("Unknown Gender", "Unknown Ethnicity", "Other", "Unknown IMD")))
}

# Check if the required column exists and the data frame is not empty
if ("new_positive_flag" %in% colnames(attendees_V2_all_clean) && nrow(attendees_V2_all_clean) > 0) {
  
  # Filter for newly diagnosed Virus2 cases
  overall_attendees_V2_new_diag <- attendees_V2_all_clean %>% filter(new_positive_flag == "New")
  
  if (nrow(overall_attendees_V2_new_diag) > 0) {
    # Count newly diagnosed Virus2 cases if any cases exist
    overall_attendees_V2_new_diag_long <- count_new_diag(overall_attendees_V2_new_diag)
  } else {
    # If no newly diagnosed cases, return an empty data frame
    overall_attendees_V2_new_diag_long <- data.frame()
  }
  
} else {
  # If the column doesn't exist or the data frame is empty, return an empty data frame
  overall_attendees_V2_new_diag_long <- data.frame()
}

```



```{r attendees-with-blood-test}
# Analyze attendees with a blood test using generic variable names
attendees_with_blood_V1 <- attendees_V1_clean %>% filter(blood_test_flag == "Yes")
attendees_with_blood_V3 <- attendees_V3_clean %>% filter(blood_test_flag == "Yes")
attendees_with_blood_V2 <- attendees_V2_clean %>% filter(blood_test_flag == "Yes")

```


```{r blood-test-prop}
# Calculate proportions of attendees tested for Virus1 across different demographics 
proportion_tested_by_age_V1 <- calculate_proportion_tested(attendees_V1_clean, "age_group")
proportion_tested_by_gender_V1 <- calculate_proportion_tested(attendees_V1_clean, "Gender")
proportion_tested_by_ethnic_group_V1 <- calculate_proportion_tested(attendees_V1_clean, "ethnic_group")
proportion_tested_by_IMD_V1 <- calculate_proportion_tested(attendees_V1_clean, "IMD")

# Combine the calculated proportions for attendees tested for Virus1
proportions_tested_V1 <- bind_rows(
  mutate(proportion_tested_by_age_V1, Demographic = "Age Group"),
  mutate(proportion_tested_by_gender_V1, Demographic = "Gender"),
  mutate(proportion_tested_by_ethnic_group_V1, Demographic = "Ethnic Group"),
  mutate(proportion_tested_by_IMD_V1, Demographic = "IMD")
)
```


```{r HIV-test}
# Proportion of Attendees tested 
proportion_tested_by_age_V1 <- calculate_proportion_tested(attendees_V1_clean, "age_group")
proportion_tested_by_gender_V1 <- calculate_proportion_tested(attendees_V1_clean, "Gender")
proportion_tested_by_ethnic_group_V1 <- calculate_proportion_tested(attendees_V1_clean, "ethnic_group")
proportion_tested_by_IMD_V1 <- calculate_proportion_tested(attendees_V1_clean, "IMD")

# Binding rows of all demographics
proportions_tested_V1 <- bind_rows(
  mutate(proportion_tested_by_age_V1, Demographic = "Age Group"),
  mutate(proportion_tested_by_gender_V1, Demographic = "Gender"),
  mutate(proportion_tested_by_ethnic_group_V1, Demographic = "Ethnic Group"),
  mutate(proportion_tested_by_IMD_V1, Demographic = "IMD")
)

# Calculate demographic breakdowns for eligible attendees tested for Virus1
eligible_demo_by_age_V1 <- calculate_eligible_tested(attendees_V1_clean, age_group, "Virus1")
eligible_demo_by_gender_V1 <- calculate_eligible_tested(attendees_V1_clean, Gender, "Virus1")
eligible_demo_by_ethnic_group_V1 <- calculate_eligible_tested(attendees_V1_clean, ethnic_group, "Virus1")
eligible_demo_by_IMD_V1 <- calculate_eligible_tested(attendees_V1_clean, IMD, "Virus1")

# Combine all demographic breakdowns
combined_eligible_demographics_V1 <- bind_rows(
  mutate(eligible_demo_by_age_V1, Demographic = "Age Group"),
  mutate(eligible_demo_by_gender_V1, Demographic = "Gender"),
  mutate(eligible_demo_by_ethnic_group_V1, Demographic = "Ethnic Group"),
  mutate(eligible_demo_by_IMD_V1, Demographic = "IMD")
)

# Calculate proportions of eligible attendees tested for Virus1 across different demographics
proportions_V1_tested_eligible_age <- proportion_tested_eligible(attendees_V1_clean, Virus1, age_group)
proportions_V1_tested_eligible_Gender <- proportion_tested_eligible(attendees_V1_clean, Virus1, Gender)
proportions_V1_tested_eligible_Ethnic_group <- proportion_tested_eligible(attendees_V1_clean, Virus1, ethnic_group)
proportions_V1_tested_eligible_IMD <- proportion_tested_eligible(attendees_V1_clean, Virus1, IMD)

# Combine the calculated proportions for eligible attendees tested for Virus1
combined_proportions_eligible_tested_V1 <- combine_and_prepare_eligible(
  list(proportions_V1_tested_eligible_Gender,
       proportions_V1_tested_eligible_age,
       proportions_V1_tested_eligible_Ethnic_group,
       proportions_V1_tested_eligible_IMD),
  c("Gender", "Age Group", "Ethnic Group", "IMD")
)

```


``` {r HCV-test}
# Analyze characteristics of attendees for Virus3
attendees_characteristics_V3 <- attendees_characteristics(attendees_V3_clean)

# Calculate proportions of attendees tested for Virus3 across different demographics
proportion_tested_by_age_V3 <- calculate_proportion_tested(attendees_V3_clean, "age_group")
proportion_tested_by_gender_V3 <- calculate_proportion_tested(attendees_V3_clean, "Gender")
proportion_tested_by_ethnic_group_V3 <- calculate_proportion_tested(attendees_V3_clean, "ethnic_group")
proportion_tested_by_IMD_V3 <- calculate_proportion_tested(attendees_V3_clean, "IMD")

# Combine the calculated proportions for attendees tested for Virus3
proportions_tested_V3 <- bind_rows(
  mutate(proportion_tested_by_age_V3, Demographic = "Age Group"),
  mutate(proportion_tested_by_gender_V3, Demographic = "Gender"),
  mutate(proportion_tested_by_ethnic_group_V3, Demographic = "Ethnic Group"),
  mutate(proportion_tested_by_IMD_V3, Demographic = "IMD")
)

# Calculate demographic breakdowns for eligible attendees tested for Virus3
eligible_demo_by_age_V3 <- calculate_eligible_tested(attendees_V3_clean, age_group, "Virus3")
eligible_demo_by_gender_V3 <- calculate_eligible_tested(attendees_V3_clean, Gender, "Virus3")
eligible_demo_by_ethnic_group_V3 <- calculate_eligible_tested(attendees_V3_clean, ethnic_group, "Virus3")
eligible_demo_by_IMD_V3 <- calculate_eligible_tested(attendees_V3_clean, IMD, "Virus3")

# Combine all demographic breakdowns
combined_eligible_demographics_V3 <- bind_rows(
  mutate(eligible_demo_by_age_V3, Demographic = "Age Group"),
  mutate(eligible_demo_by_gender_V3, Demographic = "Gender"),
  mutate(eligible_demo_by_ethnic_group_V3, Demographic = "Ethnic Group"),
  mutate(eligible_demo_by_IMD_V3, Demographic = "IMD")
)

# Calculate proportions of eligible attendees tested for Virus3
proportions_V3_tested_eligible_age <- proportion_tested_eligible(attendees_V3_clean, Virus3, age_group)
proportions_V3_tested_eligible_Gender <- proportion_tested_eligible(attendees_V3_clean, Virus3, Gender)
proportions_V3_tested_eligible_Ethnic_group <- proportion_tested_eligible(attendees_V3_clean, Virus3, ethnic_group)
proportions_V3_tested_eligible_IMD <- proportion_tested_eligible(attendees_V3_clean, Virus3, IMD)

# Combine the calculated proportions for eligible attendees tested for Virus3
combined_proportions_eligible_tested_V3 <- combine_and_prepare_eligible(
  list(proportions_V3_tested_eligible_Gender, 
       proportions_V3_tested_eligible_age, 
       proportions_V3_tested_eligible_Ethnic_group, 
       proportions_V3_tested_eligible_IMD),
  c("Gender", "Age Group", "Ethnic Group", "IMD")
)
```


``` {r HBV-test}
# Analyze characteristics of attendees for Virus2
attendees_characteristics_V2 <- attendees_characteristics(attendees_V2_clean)

# Calculate proportions of attendees tested for Virus2 across different demographics
proportion_tested_by_age_V2 <- calculate_proportion_tested(attendees_V2_clean, "age_group")
proportion_tested_by_gender_V2 <- calculate_proportion_tested(attendees_V2_clean, "Gender")
proportion_tested_by_ethnic_group_V2 <- calculate_proportion_tested(attendees_V2_clean, "ethnic_group")
proportion_tested_by_IMD_V2 <- calculate_proportion_tested(attendees_V2_clean, "IMD")

# Combine the calculated proportions for attendees tested for Virus2
proportions_tested_V2 <- bind_rows(
  mutate(proportion_tested_by_age_V2, Demographic = "Age Group"),
  mutate(proportion_tested_by_gender_V2, Demographic = "Gender"),
  mutate(proportion_tested_by_ethnic_group_V2, Demographic = "Ethnic Group"),
  mutate(proportion_tested_by_IMD_V2, Demographic = "IMD")
)

# Calculate demographic breakdowns for eligible attendees tested for Virus2
eligible_demo_by_age_V2 <- calculate_eligible_tested(attendees_V2_clean, age_group, "Virus2")
eligible_demo_by_gender_V2 <- calculate_eligible_tested(attendees_V2_clean, Gender, "Virus2")
eligible_demo_by_ethnic_group_V2 <- calculate_eligible_tested(attendees_V2_clean, ethnic_group, "Virus2")
eligible_demo_by_IMD_V2 <- calculate_eligible_tested(attendees_V2_clean, IMD, "Virus2")

# Combine all demographic breakdowns for eligible attendees
combined_eligible_demographics_V2 <- bind_rows(
  mutate(eligible_demo_by_age_V2, Demographic = "Age Group"),
  mutate(eligible_demo_by_gender_V2, Demographic = "Gender"),
  mutate(eligible_demo_by_ethnic_group_V2, Demographic = "Ethnic Group"),
  mutate(eligible_demo_by_IMD_V2, Demographic = "IMD")
)

# Calculate proportions of eligible attendees tested for Virus2 across different demographics
proportions_V2_tested_eligible_age <- proportion_tested_eligible(attendees_V2_clean, Virus2, age_group)
proportions_V2_tested_eligible_Gender <- proportion_tested_eligible(attendees_V2_clean, Virus2, Gender)
proportions_V2_tested_eligible_Ethnic_group <- proportion_tested_eligible(attendees_V2_clean, Virus2, ethnic_group)
proportions_V2_tested_eligible_IMD <- proportion_tested_eligible(attendees_V2_clean, Virus2, IMD)

# Combine the calculated proportions for eligible attendees tested for Virus2
combined_proportions_eligible_tested_V2 <- combine_and_prepare_eligible(
  list(proportions_V2_tested_eligible_Gender,
       proportions_V2_tested_eligible_age,
       proportions_V2_tested_eligible_Ethnic_group,
       proportions_V2_tested_eligible_IMD),
  c("Gender", "Age Group", "Ethnic Group", "IMD")
)
```



``` {r include-HIV-diagnosis}
# Define a function to check if all data frames in a list are empty
all_empty <- function(df_list) {
  all(sapply(df_list, function(df) nrow(df) == 0))
}

# Calculate proportions diagnosed with Virus1 across different demographics
proportion_diagnosed_V1_age <- proportion_diagnosed_V1(attendees_V1_clean, "age_group") %>% mutate(Demographic = "Age Group")
proportion_diagnosed_V1_gender <- proportion_diagnosed_V1(attendees_V1_clean, "Gender") %>% mutate(Demographic = "Gender")
proportion_diagnosed_V1_ethnic <- proportion_diagnosed_V1(attendees_V1_clean, "ethnic_group") %>% mutate(Demographic = "Ethnic Group")
proportion_diagnosed_V1_IMD <- proportion_diagnosed_V1(attendees_V1_clean, "IMD") %>% mutate(Demographic = "IMD")

# Combine the individual data frames into a list
proportion_diagnosed_list_V1 <- list(
  proportion_diagnosed_V1_age,
  proportion_diagnosed_V1_gender,
  proportion_diagnosed_V1_ethnic,
  proportion_diagnosed_V1_IMD
)

# Check if the list of data frames is empty or if all data frames inside are empty
if (length(proportion_diagnosed_list_V1) == 0 || all_empty(proportion_diagnosed_list_V1)) {
  combined_Proportion_diagnosed_long_V1 <- data.frame()
} else {
  # Proceed with combining data frames and further processing
  combined_Proportion_diagnosed_long_V1 <- bind_rows(proportion_diagnosed_list_V1) %>%
    select(Demographic, Category_Value, Proportion = Proportion_Tested) %>%
    filter(!(Category_Value %in% c("Unknown Gender", "Unknown Ethnicity", "Other", "Unknown IMD")))
}

# Check if the required column exists and the data frame is not empty for new diagnoses
if ("new_positive_flag" %in% colnames(attendees_V1_clean) && nrow(attendees_V1_clean) > 0) {
  
  # Filter for newly diagnosed Virus1 cases
  attendees_V1_new_diag <- attendees_V1_clean %>% filter(new_positive_flag == "TRUE")
  
  if (nrow(attendees_V1_new_diag) > 0) {
    # Count newly diagnosed Virus1 cases if any cases exist
    attendees_V1_new_diag_long <- count_new_diag(attendees_V1_new_diag)
  } else {
    # If no newly diagnosed cases, return an empty data frame
    attendees_V1_new_diag_long <- data.frame()
  }
  
} else {
  # If the column doesn't exist or the data frame is empty, return an empty data frame
  attendees_V1_new_diag_long <- data.frame()
}

# Check if the required column exists for previously diagnosed cases
if ("not_in_care_flag" %in% colnames(attendees_V1_clean) && nrow(attendees_V1_clean) > 0) {
  
  # Filter for previously diagnosed Virus1 cases (not in care)
  attendees_V1_prev_diag <- attendees_V1_clean %>% filter(not_in_care_flag == "TRUE")
  
  if (nrow(attendees_V1_prev_diag) > 0) {
    # Count previously diagnosed Virus1 cases if any cases exist
    attendees_V1_prev_diag_long <- count_new_diag(attendees_V1_prev_diag)
  } else {
    # If no previously diagnosed cases, return an empty data frame
    attendees_V1_prev_diag_long <- data.frame()
  }
  
} else {
  # If the column doesn't exist or the data frame is empty, return an empty data frame
  attendees_V1_prev_diag_long <- data.frame()
}

```


``` {r include-HCV-positive-diagnosis}
# Define a function to check if all data frames in a list are empty
all_empty <- function(df_list) {
  all(sapply(df_list, function(df) nrow(df) == 0))
}

# Calculate proportions diagnosed with Virus3 (antibody positive) across different demographics
proportion_diagnosed_V3Ab_age <- proportion_positive_V3(attendees_V3_clean, "age_group") %>% mutate(Demographic = "Age Group")
proportion_diagnosed_V3Ab_gender <- proportion_positive_V3(attendees_V3_clean, "Gender") %>% mutate(Demographic = "Gender")
proportion_diagnosed_V3Ab_ethnic <- proportion_positive_V3(attendees_V3_clean, "ethnic_group") %>% mutate(Demographic = "Ethnic Group")
proportion_diagnosed_V3Ab_IMD <- proportion_positive_V3(attendees_V3_clean, "IMD") %>% mutate(Demographic = "IMD")

# Combine the individual data frames into a list for antibody-positive diagnoses
proportion_diagnosed_list_V3Ab <- list(
  proportion_diagnosed_V3Ab_age,
  proportion_diagnosed_V3Ab_gender,
  proportion_diagnosed_V3Ab_ethnic,
  proportion_diagnosed_V3Ab_IMD
)

# Check if the list of data frames is empty or if all data frames inside are empty
if (length(proportion_diagnosed_list_V3Ab) == 0 || all_empty(proportion_diagnosed_list_V3Ab)) {
  combined_Proportion_diagnosed_long_V3Ab <- data.frame()
} else {
  # Proceed with combining data frames and further processing
  combined_Proportion_diagnosed_long_V3Ab <- bind_rows(proportion_diagnosed_list_V3Ab) %>%
    select(Demographic, Category_Value, Proportion = Proportion_Tested) %>%
    filter(!(Category_Value %in% c("Unknown Gender", "Unknown Ethnicity", "Other", "Unknown IMD")))
}

# Check if the required column exists and the data frame is not empty
if ("antibody_positive_flag" %in% colnames(attendees_V3_clean) && nrow(attendees_V3_clean) > 0) {
  
  # Filter for diagnosed Virus3 cases where antibody_positive_flag == "Positive"
  attendees_V3_positive_diag <- attendees_V3_clean %>% filter(antibody_positive_flag == "Positive")
  
  if (nrow(attendees_V3_positive_diag) > 0) {
    # Count Virus3 antibody-positive diagnoses if any cases exist
    attendees_V3_positive_diag_long <- count_new_diag(attendees_V3_positive_diag)
  } else {
    # If no positive cases, return an empty data frame
    attendees_V3_positive_diag_long <- data.frame()
  }
  
} else {
  # If the column doesn't exist or the data frame is empty, return an empty data frame
  attendees_V3_positive_diag_long <- data.frame()
}

```


``` {r include-HCV-diagnosis}
# Define a function to check if all data frames in a list are empty
all_empty <- function(df_list) {
  all(sapply(df_list, function(df) nrow(df) == 0))
}

# Calculate proportions diagnosed with Virus3 across different demographics
proportion_diagnosed_V3_age <- proportion_diagnosed_V3(attendees_V3_clean, "age_group") %>% mutate(Demographic = "Age Group")
proportion_diagnosed_V3_gender <- proportion_diagnosed_V3(attendees_V3_clean, "Gender") %>% mutate(Demographic = "Gender")
proportion_diagnosed_V3_ethnic <- proportion_diagnosed_V3(attendees_V3_clean, "ethnic_group") %>% mutate(Demographic = "Ethnic Group")
proportion_diagnosed_V3_IMD <- proportion_diagnosed_V3(attendees_V3_clean, "IMD") %>% mutate(Demographic = "IMD")

# Combine the individual data frames into a list
proportion_diagnosed_list_V3 <- list(
  proportion_diagnosed_V3_age,
  proportion_diagnosed_V3_gender,
  proportion_diagnosed_V3_ethnic,
  proportion_diagnosed_V3_IMD
)

# Check if the list of data frames is empty or if all data frames inside are empty
if (length(proportion_diagnosed_list_V3) == 0 || all_empty(proportion_diagnosed_list_V3)) {
  combined_Proportion_diagnosed_long_V3 <- data.frame()
} else {
  # Proceed with combining data frames and further processing
  combined_Proportion_diagnosed_long_V3 <- bind_rows(proportion_diagnosed_list_V3) %>%
    select(Demographic, Category_Value, Proportion = Proportion_Tested) %>%
    filter(!(Category_Value %in% c("Unknown Gender", "Unknown Ethnicity", "Other", "Unknown IMD")))
}

# Check if the required column exists and the data frame is not empty
if ("new_positive_flag" %in% colnames(attendees_V3_clean) && nrow(attendees_V3_clean) > 0) {
  
  # Filter for newly diagnosed Virus3 cases
  attendees_V3_new_diag <- attendees_V3_clean %>% filter(new_positive_flag == "New")
  
  if (nrow(attendees_V3_new_diag) > 0) {
    # Count newly diagnosed Virus3 cases if any cases exist
    attendees_V3_new_diag_long <- count_new_diag(attendees_V3_new_diag)
  } else {
    # If no newly diagnosed cases, return an empty data frame
    attendees_V3_new_diag_long <- data.frame()
  }
  
} else {
  # If the column doesn't exist or the data frame is empty, return an empty data frame
  attendees_V3_new_diag_long <- data.frame()
}

```


``` {r include-HBV-positive-diagnosis}
# Define a function to check if all data frames in a list are empty
all_empty <- function(df_list) {
  all(sapply(df_list, function(df) nrow(df) == 0))
}

# Calculate proportions diagnosed with Virus2 (antigen positive) across different demographics
proportion_diagnosed_V2Ag_age <- proportion_positive_V2(attendees_V2_clean, "age_group") %>% mutate(Demographic = "Age Group")
proportion_diagnosed_V2Ag_gender <- proportion_positive_V2(attendees_V2_clean, "Gender") %>% mutate(Demographic = "Gender")
proportion_diagnosed_V2Ag_ethnic <- proportion_positive_V2(attendees_V2_clean, "ethnic_group") %>% mutate(Demographic = "Ethnic Group")
proportion_diagnosed_V2Ag_IMD <- proportion_positive_V2(attendees_V2_clean, "IMD") %>% mutate(Demographic = "IMD")

# Combine the individual data frames into a list for antigen-positive diagnoses
proportion_diagnosed_list_V2Ag <- list(
  proportion_diagnosed_V2Ag_age,
  proportion_diagnosed_V2Ag_gender,
  proportion_diagnosed_V2Ag_ethnic,
  proportion_diagnosed_V2Ag_IMD
)

# Check if the list of data frames is empty or if all data frames inside are empty
if (length(proportion_diagnosed_list_V2Ag) == 0 || all_empty(proportion_diagnosed_list_V2Ag)) {
  combined_Proportion_diagnosed_long_V2Ag <- data.frame()
} else {
  # Proceed with combining data frames and further processing
  combined_Proportion_diagnosed_long_V2Ag <- bind_rows(proportion_diagnosed_list_V2Ag) %>%
    select(Demographic, Category_Value, Proportion = Proportion_Tested) %>%
    filter(!(Category_Value %in% c("Unknown Gender", "Unknown Ethnicity", "Other", "Unknown IMD")))
}

# Check if the required column exists and the data frame is not empty
if ("antigen_positive_flag" %in% colnames(attendees_V2_clean) && nrow(attendees_V2_clean) > 0) {
  
  # Filter for Virus2 diagnosed cases where antigen_positive_flag == "Positive"
  attendees_V2_positive_diag <- attendees_V2_clean %>% filter(antigen_positive_flag == "Positive")
  
  if (nrow(attendees_V2_positive_diag) > 0) {
    # Count antigen positive cases if any exist
    attendees_V2_positive_diag_long <- count_new_diag(attendees_V2_positive_diag)
  } else {
    # If no positive cases, return an empty data frame
    attendees_V2_positive_diag_long <- data.frame()
  }
  
} else {
  # If the column doesn't exist or the data frame is empty, return an empty data frame
  attendees_V2_positive_diag_long <- data.frame()
}

```


``` {r include-HBV-diagnosis}
# Define a function to check if all data frames in a list are empty
all_empty <- function(df_list) {
  all(sapply(df_list, function(df) nrow(df) == 0))
}

# Calculate proportions diagnosed with Virus2 across different demographics
proportion_diagnosed_V2_age <- proportion_diagnosed_V2(attendees_V2_clean, "age_group") %>% mutate(Demographic = "Age Group")
proportion_diagnosed_V2_gender <- proportion_diagnosed_V2(attendees_V2_clean, "Gender") %>% mutate(Demographic = "Gender")
proportion_diagnosed_V2_ethnic <- proportion_diagnosed_V2(attendees_V2_clean, "ethnic_group") %>% mutate(Demographic = "Ethnic Group")
proportion_diagnosed_V2_IMD <- proportion_diagnosed_V2(attendees_V2_clean, "IMD") %>% mutate(Demographic = "IMD")

# Combine the individual data frames into a list
proportion_diagnosed_list_V2 <- list(
  proportion_diagnosed_V2_age,
  proportion_diagnosed_V2_gender,
  proportion_diagnosed_V2_ethnic,
  proportion_diagnosed_V2_IMD
)

# Check if the list of data frames is empty or if all data frames inside are empty
if (length(proportion_diagnosed_list_V2) == 0 || all_empty(proportion_diagnosed_list_V2)) {
  combined_Proportion_diagnosed_long_V2 <- data.frame()
} else {
  # Proceed with combining data frames and further processing
  combined_Proportion_diagnosed_long_V2 <- bind_rows(proportion_diagnosed_list_V2) %>%
    select(Demographic, Category_Value, Proportion = Proportion_Tested) %>%
    filter(!(Category_Value %in% c("Unknown Gender", "Unknown Ethnicity", "Other", "Unknown IMD")))
}

# Check if the required column exists and the data frame is not empty
if ("antigen_positive_flag" %in% colnames(attendees_V2_clean) && nrow(attendees_V2_clean) > 0) {
  
  # Filter for newly diagnosed Virus2 cases (antigen positive)
  attendees_V2_new_diag <- attendees_V2_clean %>% filter(antigen_positive_flag == "New")
  
  if (nrow(attendees_V2_new_diag) > 0) {
    # Count newly diagnosed Virus2 cases if any exist
    attendees_V2_new_diag_long <- count_new_diag(attendees_V2_new_diag)
  } else {
    # If no newly diagnosed cases, return an empty data frame
    attendees_V2_new_diag_long <- data.frame()
  }
  
} else {
  # If the column doesn't exist or the data frame is empty, return an empty data frame
  attendees_V2_new_diag_long <- data.frame()
}

```


```{r site-report-summary-html, echo=FALSE, results='asis'}
# Define generic Sentinel Site codes (adjust these as needed)
sentinel_sites <- c('SITE01', 'SITE02', 'SITE03', 'SITE04', 'SITE05', 'SITE06', 'SITE07', 
                    'SITE08', 'SITE09', 'SITE10', 'SITE11', 'SITE12', 'SITE13', 'SITE14', 
                    'SITE15', 'SITE16', 'SITE17', 'SITE18', 'SITE19', 'SITE20', 'SITE21', 
                    'SITE22', 'SITE23', 'SITE24')

# Check if the current site is a Sentinel Site
is_sentinel_site <- params$site_code %in% sentinel_sites

if (is_sentinel_site) {
  # Function to get data counts if dataset exists and is not empty
  get_data_count <- function(dataset) {
    if (exists(dataset) && !is.null(get(dataset)) && nrow(get(dataset)) > 0) {
      return(nrow(get(dataset)))
    }
    return(0)
  }
  
  # Generate the data for the table using generic virus names
  summary_table <- tibble::tibble(
    `Test Type` = c("Virus1", "Virus2", "Virus3"),
    `Total Attendees` = c(
      get_data_count("attendees_V1_clean"),
      get_data_count("attendees_V2_clean"),
      get_data_count("attendees_V3_clean")
    ),
    `Total Attendees Across All Sites` = c(
      totals_V1$Total_Attendees_All_Sites,
      totals_V2$Total_Attendees_All_Sites,
      totals_V3$Total_Attendees_All_Sites
    ),
    `Attendees with Blood Test` = c(
      get_data_count("attendees_with_blood_V1"),
      get_data_count("attendees_with_blood_V2"),
      get_data_count("attendees_with_blood_V3")
    ),
    `Diagnosed Positive` = c(
      NA,  # Diagnosed positive not applicable for Virus1 in this context
      get_data_count("attendees_V2_positive_diag"),
      get_data_count("attendees_V3_positive_diag")
    ),
    `Newly Diagnosed` = c(
      get_data_count("attendees_V1_new_diag"),
      get_data_count("attendees_V2_new_diag"),
      get_data_count("attendees_V3_new_diag")
    ),
    `Previously Diagnosed (Not in Care)` = c(
      get_data_count("attendees_V1_prev_diag"),
      NA,  # No data for Virus2
      NA   # No data for Virus3
    )
  )
  
  # Render the important note
  report_summary_html <- "
  <p><strong>Important note:</strong> Please treat this report as <strong>SENSITIVE</strong>. The data include small counts and embargoed information that must not be shared beyond authorized recipients. Data for Virus1 are preliminary and subject to change as further submissions are received.</p>
  "
  
  # Add purpose and description of the report
  purpose_text <- "
  <p>The purpose of this report is to provide sites participating in the emergency department opt-out testing programme with insights on their attendees, testing equity, and the characteristics of those diagnosed to inform service delivery.</p>
  <p>This report contains visualisations of the numbers and proportions of attendees, attendees having a blood test, eligible attendees having a bloodborne virus test, and new diagnoses, all broken down by demographics.</p>
  "
  
  # Add the site-level report header using generic names
  site_header <- sprintf(
    "<h2>Site Level Report Summary for %s as of %s:</h2>",
    params$site_name,
    params$data_date
  )
  
  # Render the data table as HTML
  table_html <- knitr::kable(
    summary_table,
    format = "html",
    table.attr = "class='table table-bordered'"
  )
  
  # Add summary text below the table
  summary_text <- "
  <p>These figures represent the total numbers of attendees tested and new diagnoses made, based on Sentinel surveillance data. This cascade approach highlights both the reach of the testing programme and potential gaps in the care continuum—from initial attendance through to diagnosis and care engagement. The subsequent sections break down each stage by key demographics to support service optimisation and assess testing equity.</p>
  "
  
  # Combine all sections into one HTML output
  report_summary_html <- paste(
    report_summary_html,
    purpose_text,
    site_header,
    table_html,
    summary_text,
    sep = "\n"
  )
  
  # Output the report summary HTML
  cat(report_summary_html)
  
} else {
  # Alternative summary for non-Sentinel Sites using generic text
  alternative_summary_html <- sprintf("<h2>Site Level Report Summary for %s as of %s:</h2>", params$site_name, params$data_date)
  alternative_summary_html <- paste(alternative_summary_html, "
  <p><strong>Important note:</strong> Please treat this report as <strong>SENSITIVE</strong>. The data include small counts and embargoed information that must not be shared beyond authorized recipients. Data for Virus1 are preliminary and subject to change as further submissions are received.</p>
  <p>Insufficient data are available to generate a comprehensive report summary. This report nonetheless provides insights for sites participating in the emergency department opt-out testing programme to enhance service delivery.</p>
  ")
  
  cat(alternative_summary_html)
}

```

\pagebreak 

``` {r description-all-bbv-attendees-demographics, echo=FALSE, results='asis'}
# Display description for attendees demographics plot if data is available
if (exists("attendees_characteristics_V1") && nrow(attendees_characteristics_V1) > 0) {
  cat("This graph shows the distribution of attendees across different demographic categories: age group, gender, ethnicity, and index of multiple deprivation (IMD) quintile at", 
      params$site_name, 
      "from the launch of the ED opt-out testing programme to", 
      params$data_date, 
      ". The overall distribution across all sites is also shown for comparison.")
} 

```  


```{r attendees-visual1, echo=FALSE, results='asis'}
# Plot attendees demographics if data is available
if (exists("attendees_characteristics_V1") && nrow(attendees_characteristics_V1) > 0 && 
    exists("overall_characteristics_V1") && nrow(overall_characteristics_V1) > 0) {
  
  # Generate individual plots for site-specific and overall data using generic labels
  p1 <- plot_attendees_demographics(attendees_characteristics_V1, "Virus1", "Site-Specific Attendees by Demographics")
  p2 <- plot_attendees_demographics(overall_characteristics_V1, "Virus1", "Overall Attendees by Demographics")
  
  # Combine the plots side by side
  gridExtra::grid.arrange(p1, p2, ncol = 2)
} else {
  cat("<p>Chart not shown as data are not available for plotting demographics.</p>")
}

```         

\pagebreak 

``` {r description-proportion-bbv-blood-test-demographics, echo=FALSE, results='asis'}

# Function to check for any non-zero proportions in data
check_non_zero_proportion <- function(data) {
  summarise(data, any_non_zero = any(Proportion_Tested > 0, na.rm = TRUE))$any_non_zero
}

# Collect data availability for generic viruses
available_data <- c()
if (exists("proportions_tested_V1") && nrow(proportions_tested_V1) > 0 && check_non_zero_proportion(proportions_tested_V1)) {
  available_data <- c(available_data, "Virus1")
}
if (exists("proportions_tested_V2") && nrow(proportions_tested_V2) > 0 && check_non_zero_proportion(proportions_tested_V2)) {
  available_data <- c(available_data, "Virus2")
}
if (exists("proportions_tested_V3") && nrow(proportions_tested_V3) > 0 && check_non_zero_proportion(proportions_tested_V3)) {
  available_data <- c(available_data, "Virus3")
}

# If there is any available data, display the description
if (length(available_data) > 0) {
  cat("This graph shows the proportion of individuals who received a blood test as part of their ED attendance and were therefore eligible for an opt-out bloodborne virus test at", 
      params$site_name, "ED, by demographic categories. The overall distribution across all sites is also included for reference.\n\n")
}
```  



``` {r BBV-visual2, echo=FALSE, results='asis'}
# Plot proportion of attendees with a blood test by demographics if data is available

# Function to check for non-zero proportions in data (re-used)
check_non_zero_proportion <- function(data) {
  summarise(data, any_non_zero = any(Proportion_Tested > 0, na.rm = TRUE))$any_non_zero
}

# Check data availability for Virus1 (as an example)
if (exists("proportions_tested_V1") && exists("overall_proportions_tested_V1") &&
    nrow(proportions_tested_V1) > 0 && nrow(overall_proportions_tested_V1) > 0 &&
    check_non_zero_proportion(proportions_tested_V1) && 
    check_non_zero_proportion(overall_proportions_tested_V1)) {
  
  # Generate individual plots using generic labels
  p1 <- plot_proportions_tested(proportions_tested_V1, "Virus1", "Site-Specific Proportion Tested")
  p2 <- plot_proportions_tested(overall_proportions_tested_V1, "Virus1", "Overall Proportion Tested")
  
  # Combine the plots side by side
  gridExtra::grid.arrange(p1, p2, ncol = 2)
  
} else {
  cat("<p>Chart not shown as data are not available for 'Proportion of Attendees with a Blood Test by Demographics'.</p>")
}


```         


\pagebreak 

``` {r description-overall-eligible-bbv-tests-by-demographics, echo=FALSE, results='asis'}
# Function to check for any non-zero proportions in data
check_non_zero_proportion <- function(data) {
  summarise(data, any_non_zero = any(Proportion_Tested > 0, na.rm = TRUE))$any_non_zero
}

# Display description for eligible bloodborne virus tests by demographics
available_bbvs <- c()
if (exists("combined_overall_proportions_eligible_tested_V1") && nrow(combined_overall_proportions_eligible_tested_V1) > 0 &&
    check_non_zero_proportion(combined_overall_proportions_eligible_tested_V1)) {
  available_bbvs <- c(available_bbvs, "Virus1")
}
if (exists("combined_overall_proportions_eligible_tested_V2") && nrow(combined_overall_proportions_eligible_tested_V2) > 0 &&
    check_non_zero_proportion(combined_overall_proportions_eligible_tested_V2)) {
  available_bbvs <- c(available_bbvs, "Virus2")
}
if (exists("combined_overall_proportions_eligible_tested_V3") && nrow(combined_overall_proportions_eligible_tested_V3) > 0 &&
    check_non_zero_proportion(combined_overall_proportions_eligible_tested_V3)) {
  available_bbvs <- c(available_bbvs, "Virus3")
}

if (length(available_bbvs) > 0) {
  bbv_string <- paste(available_bbvs, collapse = ", ")
  cat(sprintf("This graph shows the uptake of testing among those eligible for %s tests across all sites, offering site-level comparison with the overall distribution.\n\n", bbv_string))
}

```


``` {r combined-overall-BBV-visualisation2, echo=FALSE, results='asis'}
# Function to check for any non-zero proportions in data
check_non_zero_proportion <- function(data) {
  summarise(data, any_non_zero = any(Proportion_Tested > 0, na.rm = TRUE))$any_non_zero
}

# Plot the proportion of eligible attendees with bloodborne virus tests by demographics if data is available
list_of_datasets <- list()

if (exists("combined_overall_proportions_eligible_tested_V1") && nrow(combined_overall_proportions_eligible_tested_V1) > 0 &&
    check_non_zero_proportion(combined_overall_proportions_eligible_tested_V1)) {
  list_of_datasets[["Virus1"]] <- combined_overall_proportions_eligible_tested_V1 %>% mutate(Test_Type = "Virus1")
}
if (exists("combined_overall_proportions_eligible_tested_V2") && nrow(combined_overall_proportions_eligible_tested_V2) > 0 &&
    check_non_zero_proportion(combined_overall_proportions_eligible_tested_V2)) {
  list_of_datasets[["Virus2"]] <- combined_overall_proportions_eligible_tested_V2 %>% mutate(Test_Type = "Virus2")
}
if (exists("combined_overall_proportions_eligible_tested_V3") && nrow(combined_overall_proportions_eligible_tested_V3) > 0 &&
    check_non_zero_proportion(combined_overall_proportions_eligible_tested_V3)) {
  list_of_datasets[["Virus3"]] <- combined_overall_proportions_eligible_tested_V3 %>% mutate(Test_Type = "Virus3")
}

num_bbv_available <- length(list_of_datasets)

if (num_bbv_available > 0) {
  combined_all_tests_with_ci <- bind_rows(list_of_datasets)
  
  if (num_bbv_available == 3) {
    bbv_test_plot_eligible(combined_all_tests_with_ci, "Proportion of Eligible Attendees with Bloodborne Virus Tests by Demographics across all Sites", "Demographic Category", "Percentage Tested", blue_palette)
  } else if (num_bbv_available == 2) {
    bbv_types <- names(list_of_datasets)
    bbv_test_plot_eligible(combined_all_tests_with_ci, sprintf("Proportion of Eligible Attendees with %s and %s Tests by Demographics across all Sites", bbv_types[1], bbv_types[2]), "Demographic Category", "Percentage Tested", blue_palette)
  } else {
    bbv_type <- names(list_of_datasets)
    bbv_test_plot_eligible(combined_all_tests_with_ci, sprintf("Proportion of Eligible Attendees with %s Tests by Demographics across all Sites", bbv_type), "Demographic Category", "Percentage Tested", blue_palette)
  }
} else {
  cat("<p>Chart not shown as data are not available for 'Proportion of Eligible Attendees with Bloodborne Virus Tests by Demographics'.</p>")
}
```


\pagebreak 

``` {r description-eligible-bbv-tests-by-demographics, echo=FALSE, results='asis'}
# Function to check for any non-zero proportions in data
check_non_zero_proportion <- function(data) {
  summarise(data, any_non_zero = any(Proportion_Tested > 0, na.rm = TRUE))$any_non_zero
}

# Display description for eligible bloodborne virus tests by demographics
available_bbvs <- c()
if (exists("combined_proportions_eligible_tested_V1") && nrow(combined_proportions_eligible_tested_V1) > 0 &&
    check_non_zero_proportion(combined_proportions_eligible_tested_V1)) {
  available_bbvs <- c(available_bbvs, "Virus1")
}
if (exists("combined_proportions_eligible_tested_V2") && nrow(combined_proportions_eligible_tested_V2) > 0 &&
    check_non_zero_proportion(combined_proportions_eligible_tested_V2)) {
  available_bbvs <- c(available_bbvs, "Virus2")
}
if (exists("combined_proportions_eligible_tested_V3") && nrow(combined_proportions_eligible_tested_V3) > 0 &&
    check_non_zero_proportion(combined_proportions_eligible_tested_V3)) {
  available_bbvs <- c(available_bbvs, "Virus3")
}

if (length(available_bbvs) > 0) {
  bbv_string <- paste(available_bbvs, collapse = ", ")
  cat(sprintf("This graph shows the uptake of testing among those eligible for %s tests. This helps identify potential disparities in testing rates across different demographic groups as well as illuminating overall testing uptake for each virus through the Programme at %s as of %s.\n\n", bbv_string, params$site_name, params$data_date))
}

```


``` {r combined-BBV-visualisation2, echo=FALSE, results='asis'}
# Function to check for any non-zero proportions in data
check_non_zero_proportion <- function(data) {
  summarise(data, any_non_zero = any(Proportion_Tested > 0, na.rm = TRUE))$any_non_zero
}

# Plot proportion of eligible attendees with bloodborne virus tests by demographics if data is available
list_of_datasets <- list()

if (exists("combined_proportions_eligible_tested_V1") && nrow(combined_proportions_eligible_tested_V1) > 0 &&
    check_non_zero_proportion(combined_proportions_eligible_tested_V1)) {
  list_of_datasets[["Virus1"]] <- combined_proportions_eligible_tested_V1 %>% mutate(Test_Type = "Virus1")
}
if (exists("combined_proportions_eligible_tested_V2") && nrow(combined_proportions_eligible_tested_V2) > 0 &&
    check_non_zero_proportion(combined_proportions_eligible_tested_V2)) {
  list_of_datasets[["Virus2"]] <- combined_proportions_eligible_tested_V2 %>% mutate(Test_Type = "Virus2")
}
if (exists("combined_proportions_eligible_tested_V3") && nrow(combined_proportions_eligible_tested_V3) > 0 &&
    check_non_zero_proportion(combined_proportions_eligible_tested_V3)) {
  list_of_datasets[["Virus3"]] <- combined_proportions_eligible_tested_V3 %>% mutate(Test_Type = "Virus3")
}

num_bbv_available <- length(list_of_datasets)

if (num_bbv_available > 0) {
  combined_all_tests_with_ci <- bind_rows(list_of_datasets)
  
  if (num_bbv_available == 3) {
    # All three viruses meet criteria - plot combined graph
    bbv_test_plot_eligible(combined_all_tests_with_ci, "Proportion of Eligible Attendees with Bloodborne Virus Tests by Demographics across all Sites", "Demographic Category", "Percentage Tested", blue_palette)
  } else if (num_bbv_available == 2) {
    bbv_types <- names(list_of_datasets)
    bbv_test_plot_eligible(combined_all_tests_with_ci, sprintf("Proportion of Eligible Attendees with %s and %s Tests by Demographics across all Sites", bbv_types[1], bbv_types[2]), "Demographic Category", "Percentage Tested", blue_palette)
  } else {
    bbv_type <- names(list_of_datasets)
    bbv_test_plot_eligible(combined_all_tests_with_ci, sprintf("Proportion of Eligible Attendees with %s Tests by Demographics across all Sites", bbv_type), "Demographic Category", "Percentage Tested", blue_palette)
  }
} else {
  cat("<p>Chart not shown as data are not available for 'Proportion of Eligible Attendees with Bloodborne Virus Tests by Demographics'.</p>")
}

```


\pagebreak 

```{r description-overall-newly-diagnosed-bbv-by-demographics, echo=FALSE, results='asis'}
# Display description for overall newly diagnosed bloodborne virus cases by demographics
available_bbvs <- c()

if (exists("overall_combined_Proportion_diagnosed_long_V3") &&
    nrow(overall_combined_Proportion_diagnosed_long_V3) > 0 &&
    any(!is.na(overall_combined_Proportion_diagnosed_long_V3$Proportion) &
        overall_combined_Proportion_diagnosed_long_V3$Proportion > 0)) {
  available_bbvs <- c(available_bbvs, "Virus3")
}
if (exists("overall_combined_Proportion_diagnosed_long_V2") &&
    nrow(overall_combined_Proportion_diagnosed_long_V2) > 0 &&
    any(!is.na(overall_combined_Proportion_diagnosed_long_V2$Proportion) &
        overall_combined_Proportion_diagnosed_long_V2$Proportion > 0)) {
  available_bbvs <- c(available_bbvs, "Virus2")
}
if (exists("overall_combined_Proportion_diagnosed_long_V1") &&
    nrow(overall_combined_Proportion_diagnosed_long_V1) > 0 &&
    any(!is.na(overall_combined_Proportion_diagnosed_long_V1$Proportion) &
        overall_combined_Proportion_diagnosed_long_V1$Proportion > 0)) {
  available_bbvs <- c(available_bbvs, "Virus1")
}

if (length(available_bbvs) > 0) {
  bbv_string <- paste(available_bbvs, collapse = ", ")
  cat(sprintf("These graphs show the proportion of newly diagnosed patients for %s by demographics across all sites, offering site-level comparison with overall distribution as of %s.\n\n", bbv_string, params$data_date))
} else {
  cat("Chart not shown as data are not available for 'Proportion of Newly Diagnosed patients by Demographics for Bloodborne Viruses'.\n\n")
}
 
```
 
 
```{r overall-combined-BBV-visualisation, echo=FALSE, results='asis'}
# Plot proportion of overall newly diagnosed patients by demographics for bloodborne viruses if valid data is available
list_of_overall_diagnosed_datasets <- list()

if (exists("overall_combined_Proportion_diagnosed_long_V3") &&
    nrow(overall_combined_Proportion_diagnosed_long_V3) > 0 &&
    any(!is.na(overall_combined_Proportion_diagnosed_long_V3$Proportion) &
        overall_combined_Proportion_diagnosed_long_V3$Proportion > 0)) {
  list_of_overall_diagnosed_datasets[["Virus3"]] <- overall_combined_Proportion_diagnosed_long_V3 %>% mutate(Test_Type = "Virus3")
}
if (exists("overall_combined_Proportion_diagnosed_long_V2") &&
    nrow(overall_combined_Proportion_diagnosed_long_V2) > 0 &&
    any(!is.na(overall_combined_Proportion_diagnosed_long_V2$Proportion) &
        overall_combined_Proportion_diagnosed_long_V2$Proportion > 0)) {
  list_of_overall_diagnosed_datasets[["Virus2"]] <- overall_combined_Proportion_diagnosed_long_V2 %>% mutate(Test_Type = "Virus2")
}
if (exists("overall_combined_Proportion_diagnosed_long_V1") &&
    nrow(overall_combined_Proportion_diagnosed_long_V1) > 0 &&
    any(!is.na(overall_combined_Proportion_diagnosed_long_V1$Proportion) &
        overall_combined_Proportion_diagnosed_long_V1$Proportion > 0)) {
  list_of_overall_diagnosed_datasets[["Virus1"]] <- overall_combined_Proportion_diagnosed_long_V1 %>% mutate(Test_Type = "Virus1")
}

num_bbv_available <- length(list_of_overall_diagnosed_datasets)

if (num_bbv_available > 0) {
  overall_combined_prop_diag <- bind_rows(list_of_overall_diagnosed_datasets)
  # Only proceed if valid data is available after filtering
  valid_data <- overall_combined_prop_diag %>% filter(!is.na(Proportion) & Proportion > 0)
  if (nrow(valid_data) == 0) {
    cat("<p>No valid data available for plotting.</p>")
  } else {
    if (num_bbv_available == 3) {
      proportion_diagnosed_plot(valid_data, "Proportion of Newly Diagnosed patients by Demographics across all sites for Virus2, Virus3, and Virus1", "Demographic Category", "Percentage Tested")
    } else if (num_bbv_available == 2) {
      bbv_types <- names(list_of_overall_diagnosed_datasets)
      proportion_diagnosed_plot(valid_data, sprintf("Proportion of Newly Diagnosed patients by Demographics across all sites for %s and %s", bbv_types[1], bbv_types[2]), "Demographic Category", "Percentage Tested")
    } else {
      bbv_type <- names(list_of_overall_diagnosed_datasets)
      proportion_diagnosed_plot(valid_data, sprintf("Proportion of Newly Diagnosed patients by Demographics across all sites for %s", bbv_type), "Demographic Category", "Percentage Tested")
    }
  }
} else {
  cat("<p>Chart not shown as data are not available for 'Proportion of Newly Diagnosed patients by Demographics across all sites for Bloodborne Viruses'.</p>")
}

```


\pagebreak 

``` {r description-newly-diagnosed-hbv-hcv-hiv-by-demographics, echo=FALSE, results='asis'}
# Display description for newly diagnosed bloodborne virus cases by demographics
available_bbvs <- c()

if (exists("combined_Proportion_diagnosed_long_V3") &&
    nrow(combined_Proportion_diagnosed_long_V3) > 0 &&
    any(!is.na(combined_Proportion_diagnosed_long_V3$Proportion) & combined_Proportion_diagnosed_long_V3$Proportion > 0)) {
  available_bbvs <- c(available_bbvs, "Virus3")
}
if (exists("combined_Proportion_diagnosed_long_V2") &&
    nrow(combined_Proportion_diagnosed_long_V2) > 0 &&
    any(!is.na(combined_Proportion_diagnosed_long_V2$Proportion) & combined_Proportion_diagnosed_long_V2$Proportion > 0)) {
  available_bbvs <- c(available_bbvs, "Virus2")
}
if (exists("combined_Proportion_diagnosed_long_V1") &&
    nrow(combined_Proportion_diagnosed_long_V1) > 0 &&
    any(!is.na(combined_Proportion_diagnosed_long_V1$Proportion) & combined_Proportion_diagnosed_long_V1$Proportion > 0)) {
  available_bbvs <- c(available_bbvs, "Virus1")
}

if (length(available_bbvs) > 0) {
  bbv_string <- paste(available_bbvs, collapse = ", ")
  cat(sprintf("These graphs show the proportion of newly diagnosed patients for %s by demographics at %s, offering insights into the prevalence of these viruses by demographic groups as of %s.\n\n", 
              bbv_string, params$site_name, params$data_date))
} else {
  cat("Chart not shown as data are not available for 'Proportion of Newly Diagnosed patients by Demographics for Bloodborne Viruses'.\n\n")
}
 
```
 
 
```{r combined-BBV-visualisation3, echo=FALSE, results='asis'}
# Plot proportion of overall newly diagnosed patients by demographics for bloodborne viruses if valid data is available
list_of_diagnosed_datasets <- list()

if (exists("combined_Proportion_diagnosed_long_V3") &&
    nrow(combined_Proportion_diagnosed_long_V3) > 0 &&
    any(!is.na(combined_Proportion_diagnosed_long_V3$Proportion) & combined_Proportion_diagnosed_long_V3$Proportion > 0)) {
  list_of_diagnosed_datasets[["Virus3"]] <- combined_Proportion_diagnosed_long_V3 %>% mutate(Test_Type = "Virus3")
}
if (exists("combined_Proportion_diagnosed_long_V2") &&
    nrow(combined_Proportion_diagnosed_long_V2) > 0 &&
    any(!is.na(combined_Proportion_diagnosed_long_V2$Proportion) & combined_Proportion_diagnosed_long_V2$Proportion > 0)) {
  list_of_diagnosed_datasets[["Virus2"]] <- combined_Proportion_diagnosed_long_V2 %>% mutate(Test_Type = "Virus2")
}
if (exists("combined_Proportion_diagnosed_long_V1") &&
    nrow(combined_Proportion_diagnosed_long_V1) > 0 &&
    any(!is.na(combined_Proportion_diagnosed_long_V1$Proportion) & combined_Proportion_diagnosed_long_V1$Proportion > 0)) {
  list_of_diagnosed_datasets[["Virus1"]] <- combined_Proportion_diagnosed_long_V1 %>% mutate(Test_Type = "Virus1")
}

num_bbv_available <- length(list_of_diagnosed_datasets)

if (num_bbv_available > 0) {
  combined_prop_diag <- bind_rows(list_of_diagnosed_datasets)
  # Only proceed if valid data is available after filtering
  valid_data <- combined_prop_diag %>% filter(!is.na(Proportion) & Proportion > 0)
  if (nrow(valid_data) == 0) {
    cat("<p>No valid data available for plotting.</p>")
  } else {
    if (num_bbv_available == 3) {
      proportion_diagnosed_plot(valid_data, "Proportion of Newly Diagnosed patients by Demographics across all sites for Virus2, Virus3, and Virus1", "Demographic Category", "Percentage Tested")
    } else if (num_bbv_available == 2) {
      bbv_types <- names(list_of_diagnosed_datasets)
      proportion_diagnosed_plot(valid_data, sprintf("Proportion of Newly Diagnosed patients by Demographics across all sites for %s and %s", bbv_types[1], bbv_types[2]), "Demographic Category", "Percentage Tested")
    } else {
      bbv_type <- names(list_of_diagnosed_datasets)
      proportion_diagnosed_plot(valid_data, sprintf("Proportion of Newly Diagnosed patients by Demographics across all sites for %s", bbv_type), "Demographic Category", "Percentage Tested")
    }
  }
} else {
  cat("<p>Chart not shown as data are not available for 'Proportion of Newly Diagnosed patients by Demographics for Bloodborne Viruses'.</p>")
}

``` 


\pagebreak
 
``` {r description-newly-diagnosed-bbv-by-demographics, echo=FALSE, results='asis'}
# Display description for newly diagnosed bloodborne virus cases by demographics
available_bbvs <- c()

if (exists("attendees_V3_new_diag_long") && nrow(attendees_V3_new_diag_long) > 0) {
  available_bbvs <- c(available_bbvs, "Virus3")
}
if (exists("attendees_V2_new_diag_long") && nrow(attendees_V2_new_diag_long) > 0) {
  available_bbvs <- c(available_bbvs, "Virus2")
}
if (exists("attendees_V1_new_diag_long") && nrow(attendees_V1_new_diag_long) > 0) {
  available_bbvs <- c(available_bbvs, "Virus1")
}

if (length(available_bbvs) > 0) {
  bbv_string <- paste(available_bbvs, collapse = ", ")
  cat(sprintf("These graphs show the counts of newly diagnosed patients for %s by demographic groups at %s, as of %s. They highlight the demographic segments witnessing new cases, which is essential for targeted healthcare strategies.\n\n", 
              bbv_string, params$site_name, params$data_date))
} else {
  cat("Chart not shown as data are not available for 'Count of Newly Diagnosed Patients by Demographics for Bloodborne Viruses'.\n\n")
}

```
 
 
```{r combined-BBV-visualisation4, echo=FALSE, results='asis'}
# Plot number of newly diagnosed bloodborne virus patients by demographics if data is available
list_of_new_diag_datasets <- list()

if (exists("attendees_V3_new_diag_long") && nrow(attendees_V3_new_diag_long) > 0) {
  list_of_new_diag_datasets[["Virus3"]] <- attendees_V3_new_diag_long %>% mutate(Test_Type = "Virus3")
}
if (exists("attendees_V2_new_diag_long") && nrow(attendees_V2_new_diag_long) > 0) {
  list_of_new_diag_datasets[["Virus2"]] <- attendees_V2_new_diag_long %>% mutate(Test_Type = "Virus2")
}
if (exists("attendees_V1_new_diag_long") && nrow(attendees_V1_new_diag_long) > 0) {
  list_of_new_diag_datasets[["Virus1"]] <- attendees_V1_new_diag_long %>% mutate(Test_Type = "Virus1")
}

num_bbv_available <- length(list_of_new_diag_datasets)

if (num_bbv_available > 0) {
  combined_BBV_counts <- bind_rows(list_of_new_diag_datasets)
  if (num_bbv_available == 3) {
    # All three viruses meet criteria - plot combined graph
    plot_new_diag_count(combined_BBV_counts, "Count of Newly Diagnosed Virus2, Virus3, and Virus1 Patients by Demographics", "Demographic Category", "Count of New Diagnoses")
  } else if (num_bbv_available == 2) {
    bbv_types <- names(list_of_new_diag_datasets)
    plot_new_diag_count(combined_BBV_counts, sprintf("Count of Newly Diagnosed %s and %s Patients by Demographics", bbv_types[1], bbv_types[2]), "Demographic Category", "Count of New Diagnoses")
  } else {
    bbv_type <- names(list_of_new_diag_datasets)
    plot_new_diag_count(combined_BBV_counts, sprintf("Count of Newly Diagnosed %s Patients by Demographics", bbv_type), "Demographic Category", "Count of New Diagnoses")
  }
} else {
  cat("<p>Chart not shown as data are not available for 'Count of Newly Diagnosed Patients by Demographics for Bloodborne Viruses'.</p>")
}

```

\pagebreak
 
```{r description-overall-previously-diagnosed-hiv, echo=FALSE, results='asis'}
# Display description for overall previously diagnosed Virus1 cases by demographics
if (exists("overall_attendees_V1_prev_diag_long") && nrow(overall_attendees_V1_prev_diag_long) > 0) {
  cat(sprintf("These graphs show the counts of previously diagnosed patients for Virus1 (not in care) across all sites, offering site-level comparison with overall distribution as of %s.\n\n", params$data_date))
} else {
  cat("Chart not shown as data are not available for 'Count of Overall Previously Diagnosed Virus1 Patients (not in care) by Demographics'.\n\n")
}

```
 
 
```{r overall-combined-BBV-visualisation5, echo=FALSE, results='asis'}
# Plot number of overall previously diagnosed Virus1 patients (not in care) by demographics if data is available
if (exists("overall_attendees_V1_prev_diag_long") && nrow(overall_attendees_V1_prev_diag_long) > 0) {
  combined_overall_BBV_counts <- overall_attendees_V1_prev_diag_long %>% mutate(Test_Type = "Virus1")
  plot_new_diag_count(combined_overall_BBV_counts, "Count of Previously Diagnosed Virus1 Patients (Not in Care) by Demographics across all Sites", "Demographic Category", "Count of Previously Diagnosed and Not in Care")
} else {
  cat("<p>Chart not shown as data are not available for 'Count of Overall Previously Diagnosed Virus1 Patients (Not in Care) by Demographics across all Sites'.</p>")
}
 
```
 
\pagebreak
 
``` {r description-previously-diagnosed-hiv-by-demographics, echo=FALSE, results='asis'}
# Display description for previously diagnosed Virus1 cases by demographics
available_v1 <- c()
if (exists("attendees_V1_prev_diag_long") && nrow(attendees_V1_prev_diag_long) > 0) {
  available_v1 <- c(available_v1, "Virus1")
}

if (length(available_v1) > 0) {
  v1_string <- paste(available_v1, collapse = ", ")
  cat(sprintf("These graphs show the counts of previously diagnosed patients for %s and not in care by demographic groups at %s, as of %s. They highlight gaps in retention to care in demographic segments, which is essential for targeting reengagement efforts for those who may have fallen out of care.\n\n", 
              v1_string, params$site_name, params$data_date))
} else {
  cat("Chart not shown as data are not available for 'Count of Previously Diagnosed Virus1 Patients and not in care by Demographics'.\n\n")
}
 
```
 
 
``` {r combined-BBV-visualisation5, echo=FALSE, results='asis'}
# Plot number of previously diagnosed Virus1 patients and not in care by demographics if data is available
list_of_prev_diag_datasets <- list()

if (exists("attendees_V1_prev_diag_long") && nrow(attendees_V1_prev_diag_long) > 0) {
  list_of_prev_diag_datasets[["Virus1"]] <- attendees_V1_prev_diag_long %>% mutate(Test_Type = "Virus1")
}

num_v1_available <- length(list_of_prev_diag_datasets)

if (num_v1_available > 0) {
  combined_BBV_counts <- bind_rows(list_of_prev_diag_datasets)
  # Only one virus meets criteria – plot it individually
  v1_type <- names(list_of_prev_diag_datasets)
  plot_new_diag_count(combined_BBV_counts, sprintf("Count of Previously Diagnosed %s Patients and not in care by Demographics", v1_type), "Demographic Category", "Count of Previously Diagnosed and not in care")
} else {
  cat("<p>Chart not shown as data are not available for 'Count of Previously Diagnosed Virus1 Patients and not in care by Demographics'.</p>")
}
 
#Run the plot
 
```