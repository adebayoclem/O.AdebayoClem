---
title: "Linkage Strategies"
author: "Jessica Edney"
date: "2024-04-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# SETUP

## Import packages

```{r packages}
pacman::p_load(
  pacman,
  tidyverse,
  readxl,
  writexl,
  DBI,
  odbc,
  knitr,
  data.table,
  kableExtra,
  janitor
)

# if needed: rm(list=ls())
```

## Run cleaning

```{r clean}
# takes a long time to run - do in VM
source("01_linking/cleaning_for_linkage.R")
```

# INVESTIGATE DATA

We need to check the completeness and distinctness of the key variables

## ECDS

```{r summarise ECDS}
ECDS_summary
```

In ECDS, there are 2,373,264 unique IDs for 15,449,446 observations. The most complete variables are unique person ID, arrival date, provider code, and age at arrival (all 100%). NHS number is complete for just over 97% of observations. The variables with most distinct values are unique person ID, NHS number, and postcode.

## SGSS

```{r summarise_SGSS}
SGSS_summary
```

In SGSS, there are 230,915 unique specimen numbers for 230,997 observations. The most complete variables are specimen number, specimen date, date of birth, and age (all 100%). NHS number is complete for just under 94% of observations. The variables with most distinct values are specimen number, NHS number, and postcode.

# MATCH ON NHS NUMBER

Firstly, we will see how many exact matches there are on NHS number.

```{r nhs_match}
nhs_num_match <-
  left_join(
    ECDS_clean,
    SGSS_clean,
    by = join_by("P_nhs_number" == "L_nhs_number"),
    na_matches = "never",
    keep = TRUE
  ) %>%
  mutate(match = ifelse(is.na(L_id), FALSE, TRUE))

nhs_num_match_tbl <- nhs_num_match %>%
  group_by(match) %>%
  tally()

nhs_num_match_tbl %>%
  mutate(percent = round((n/sum(n))*100,2))
```

There are 3,635,263 records in ECDS which match with records in SGSS by NHS number. 22% of observations in ECDS have a matching NHS number in SGSS. 78% of observations in ECDS have no matching NHS number in SGSS.

```{r nhs_missing}
nhs_num_match_false <- nhs_num_match %>%
  filter(match == FALSE) %>%
  select(starts_with("P")) 

nhs_num_match_false %>%
  mutate(missing_nhs_no = ifelse(is.na(P_nhs_number),"YES","NO")) %>%
  group_by(missing_nhs_no) %>%
  tally()
```
Of the 13,241,149 observations with no match on NHS number in SGSS, 12,833,936 have a complete NHS number so can be discarded as non-matches, and 407,213 have a missing NHS number so we can investigate these further.

# MATCH ON DATE OF BIRTH AND POSTCODE
Now to match on date of birth and postcode (need both)

```{r dob}
dob_pcode_match <- nhs_num_match_false %>%
  filter(is.na(P_nhs_number)) %>%
  left_join(
    SGSS_clean,
    by = join_by("P_birth_date" == "L_birth_date", "P_postcode" == "L_postcode"),
    na_matches = "never",
    keep = TRUE
  ) %>%
  mutate(match = ifelse(is.na(L_id), FALSE, TRUE))

dob_pcode_match_tbl <- dob_pcode_match %>%
  group_by(match) %>%
  tally()

dob_pcode_match_tbl %>%
  mutate(percent = round((n/sum(n))*100,2))
```

Exact matching just on date of birth and postcode yields an additional 10,148 matches (2.5% of those who had a missing NHS number).

# MATCH ON SEX
We want to check if observations matching on date of birth and postcode agree on sex. It is a true match if sex is not missing in either dataset and both agree.
```{r sex_match}
dob_pcode_sex_match <- dob_pcode_match %>%
  filter(match == TRUE) %>%
  mutate(match = ifelse((P_sex == L_sex & (P_sex != "MISSING" | L_sex != "MISSING")), TRUE, FALSE))

dob_pcode_sex_match_tbl <- dob_pcode_sex_match %>%
  group_by(match) %>%
  tally()

dob_pcode_sex_match_tbl %>%
  ungroup() %>%
  mutate(percent = round((n/sum(n))*100,2)) %>%
  arrange(-percent)
```
Filtering out those who don't match on sex leaves 9,945 observations in ECDS with a match in SGSS based on postcode, date of birth, and sex. We need to check for missing sex.

```{r sex_missing}
sex_match_false <- dob_pcode_sex_match %>%
  filter(match == FALSE)

sex_match_false_tbl <- sex_match_false %>%
  mutate(missing_sex = ifelse((P_sex == "MISSING" | L_sex == "MISSING"),"YES","NO"))
  
sex_match_false_tbl %>%
  group_by(missing_sex) %>%
  tally()
```
Of the 203 observations with no match for sex in SGSS, 143 truly disagree so can be discarded as non-matches, but 60 have sex missing in at least one dataset so we can include those in the potential matches and investigate further.

# MATCH ON DATE (incl NHS NUM MATCHES)
We need to check if the specimen date and arrival date are within 7 days of one another. First we bring back in the NHS number matches and include them in the pool of potential matches alongside those that match on DOB, postcode, and sex (unless sex is missing).
```{r date_match}
dob_pcode_sex_date_match <- dob_pcode_sex_match %>%
  filter(match == TRUE | (P_sex == "MISSING" | L_sex == "MISSING")) 

nhs_num_match_true <- nhs_num_match %>%
  filter(match == TRUE)

all_matches <- bind_rows(dob_pcode_sex_date_match, nhs_num_match_true) %>% 
  mutate(date_diff = P_date_int - L_date_int) %>%
  mutate(match = ifelse(
    date_diff <= 7 & date_diff >= -7,
    "YES",
    "NO"))

all_matches %>%
  group_by(match) %>%
  tally()
```
Of the 3,645,268 records in ECDS with either a match on NHS number OR on date of birth AND postcode and non-discordant sex, 1,572,517 have dates within 7 days of one another while 2,072,751 do not.

# COMPARING MATCHING JUST ON NHS NUMBER VS. MULTI-STAGE PROCESS
To see how many additional matches are yielded by the multi-stage process, first we see how many matches there are just on NHS number
```{r nhs_date_match}
nhs_date_match <- nhs_num_match %>%
  filter(match == TRUE) %>% 
  mutate(date_diff = P_date_int - L_date_int) %>%
  mutate(match = ifelse(
    date_diff <= 7 & date_diff >= -7,
    "YES",
    "NO"))

nhs_date_match %>%
  group_by(match) %>%
  tally()
```
Of the 3,635,263 matches on NHS number, 1,567,209 have dates within 7 days of one another. This compares to 1,572,517 when including matching DOB, postcode, and non-discordant sex.

```{r compared_strategies}
nhs_date_match_tbl <- nhs_date_match %>%
  group_by(match) %>%
  tally() %>%
  rename(nhs_match = n)

all_matches_tbl <- all_matches %>%
  group_by(match) %>%
  tally() %>%
  rename(dob_pcode_match = n)

matches_compared <- left_join(
  nhs_date_match_tbl,
  all_matches_tbl,
  by = "match"
) %>%
  mutate(abs_diff = dob_pcode_match - nhs_match) %>%
  mutate(perc_diff = (abs_diff/nhs_match)*100)

matches_compared
```

This shows just a 0.33% increase in matches when matching on DOB, postcode, non-discordant sex, and agreeing dates, compared to just NHS number. 