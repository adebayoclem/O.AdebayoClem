---
title: "Database breakdown"
output: html_document
date: "2024-06-25"
---


```{r setup, include=FALSE}

# Set global chunk options
knitr::opts_chunk$set(
  echo = FALSE,      # Hide code in output
  error = FALSE,     # Show errors but don't stop rendering
  warning = FALSE,   # Hide warnings in output
  message = FALSE,   # Hide messages in output
  fig.width = 12,    # Set figure width
  fig.height = 14,   # Set figure height
  fig.topcaption = TRUE  # Place figure captions at the top
)

# Ensure the "pacman" package is installed
if (!require("pacman")) {
  install.packages("pacman") }

# Load necessary packages using pacman
pacman::p_load(
 # rio,        # For data import/export
 # here,       # For relative file paths
 # skimr,      # For summarizing data
  janitor,    # For data cleaning
 # lubridate,  # For date handling
 # epikit,     # For epidemiological tools
  tidyverse,  # For data manipulation and visualization
#  flextable,  # For creating pretty tables
 # scales,     # For scaling functions
  #gtsummary,  # For summary statistics and tables
 # arrow,      # For data interoperability
  ggplot2,    # For data visualization
 # rlang,      # For programming tools
 # readxl,     # For reading Excel files
#  writexl,    # For writing Excel files
  DBI,        # For database connections
  odbc,       # For ODBC connections
 # purrr,      # For functional programming
  rmarkdown,  # For dynamic document generation
 # ukhsacharts, # For UKHSA chart formats

RODBC,#this was an alternative line for importing sQL data
dplyr,
dbplyr,
ggVennDiagram
)

# Define UKHSA color palette
blue_palette <- c("#00A5DF", "#007C91", "#1D57A5")  
```


## R Markdown

```{r}

#Connect to server Y006 - datalake for ECDS

Y006 <- odbc::dbConnect(odbc::odbc(),
                        .connection_string = "driver={SQL Server};server=SQLClusColLK19\\Lake19;
                             database=Y006_BBV_PID;
                             Encrypt=true;trusted_connection=true",
                        timeout = 300,
                        timezone = Sys.timezone(),
                        timezone_out = Sys.timezone())


```


```{r}
#Connect to server with sentinel 


Sentinel <- odbc::dbConnect(odbc::odbc(),
                        .connection_string = "driver={SQL Server};server=SQLClusColHFN17\\HFN17;
                             database=NIS_HepatitisSentinel;
                             Encrypt=true;trusted_connection=true",
                        timeout = 300,
                        timezone = Sys.timezone(),
                        timezone_out = Sys.timezone())

```

```{r}
#Connect to server with SGSS


SGSS <- odbc::dbConnect(odbc::odbc(),
                        .connection_string = "driver={SQL Server};server=SQLClusColHFN17\\HFN17;
                             database=NIS_Hepatitis;
                             Encrypt=true;trusted_connection=true",
                        timeout = 300,
                        timezone = Sys.timezone(),
                        timezone_out = Sys.timezone())

```


```{r}


HBV_SGSS <- DBI::dbGetQuery(conn = SGSS , statement = " select * from HBV_ALL")

```


```{r}

  HCV <- DBI::dbGetQuery(conn = Y006 , statement = " select * from SentinelED24_HCV")
 # HBV_test <- DBI::dbGetQuery(conn = Y006 , statement = " select * from SentinelED24_HBV where FirstHBVtestdate <= '2023-04-07'")


 ##ED24 <- DBI::dbGetQuery(conn = Y006 , statement = " select * from ED_RP24")

```

#Data contained within Sentinel before linking with ECDS 


Definition of Sentinel data can be seen here:

https://phecloud.sharepoint.com/:x:/r/teams/HepatitisSection-EDtesting/_layouts/15/Doc.aspx?sourcedoc=%7B64923ADE-E34F-4D0C-9CBD-CCCACC659AB0%7D&file=Sentinel%20Surveillance%20table%20descriptions.xlsx&action=default&mobileredirect=true&wdsle=0



#GP registration 

This data had been filtered by DBS matching. If there is DBS matching present then 
```{r}

ED24 <- ED24 %>%  rowwise() %>%  mutate(GPSatus = ifelse(!is.na(RegisterGP),'yes','No'))

ED24_dbsfiltered <- subset(ED24, !is.na(DBSScore))


ED24_GPstatus <- ggplot(ED24_dbsfiltered, aes(x = GPSatus)) +
    geom_bar() +
    labs(
         x = "GPSatus",
         y = "Number of attendees") +
    theme_minimal()

#ED24_GPstatus

```



#Evidence of homelessness


This data had been filtered by DBS matching. If there is DBS matching present then data is not included
```{r}


ED24_homelessflag <- ggplot(ED24_dbsfiltered, aes(x = homelessflag)) +
    geom_bar() +
    labs(
         x = "Evidence of homelessness",
         y = "Number of attendees") +
    theme_minimal()

ED24_homelessflag

```



#Testing in prison of drug service 


```{r}

HCV <- HCV %>%
  mutate(other_test_local = ifelse(!is.na(testedinaprison) & testedinaprison == "Yes" | !is.na(testedindrugservice) & testedindrugservice == "Yes", "Yes", "No"))


# Count the occurrences of 'Yes' and 'No' in column other_test_local
HCV_local_summary <- HCV %>%
  group_by(other_test_local) %>%
  summarise(count = n()) %>%
  ungroup()

# Create the pie chart
local_pie <- ggplot(HCV_local_summary, aes(x = "", y = count, fill = other_test_local)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +
  labs(fill = "Value", title = "Proportion of Yes vs No") +
  theme_void() +
  scale_fill_manual(values = c("Yes" = "steelblue", "No" = "tomato"))

#local_pie

HCV_local_plot <- ggplot(HCV, aes(x = other_test_local)) +
    geom_bar() +
    labs(
         x = "Tested in either a prison and or drug service",
         y = "Number of attendees") +
    theme_minimal()

#HCV_local_plot

```



#combined risk factor flag
```{r}

#included risk factors here: GP flag, homeless flag,  

HCV_DIAG_SENTINEL<- HCV

# lower case 
HCV_DIAG_SENTINEL <- mutate(HCV_DIAG_SENTINEL, antiHCV = tolower(antiHCV)) 
HCV_DIAG_SENTINEL <- mutate(HCV_DIAG_SENTINEL, HCVRNA = tolower(HCVRNA)) 
HCV_DIAG_SENTINEL <- mutate(HCV_DIAG_SENTINEL, HCVAg = tolower(HCVAg))

# Replace "15-24" with "16-24" in the age group column
HCV_DIAG_SENTINEL$agegroup[HCV_DIAG_SENTINEL$agegroup == "15-24"] <- "16-24"

#remove under 16s (for column matching, only two values and neither positive )
HCV_DIAG_SENTINEL<- HCV_DIAG_SENTINEL %>% filter(!(agegroup=='Under 16'))

# Rename gender variable in the sex column
#differnt code for this renaming as dplyr couldn't deal with case change

HCV_DIAG_SENTINEL$sex <- ifelse(HCV_DIAG_SENTINEL$sex =='MALE','Men',HCV_DIAG_SENTINEL$sex)
HCV_DIAG_SENTINEL$sex <- ifelse(HCV_DIAG_SENTINEL$sex =='FEMALE','Women',HCV_DIAG_SENTINEL$sex)
HCV_DIAG_SENTINEL$sex <- ifelse(HCV_DIAG_SENTINEL$sex =='UNKNOWN','Unknown Gender',HCV_DIAG_SENTINEL$sex)


#rename column to match mastertable for aggregation function 
names(HCV_DIAG_SENTINEL)[names(HCV_DIAG_SENTINEL)=='sex']<- 'Gender'



#Rename ethnicity 
#in other tables this has been done in SQL
HCV_DIAG_SENTINEL <- HCV_DIAG_SENTINEL %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Mixed", "Mixed/Multiple")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Indian", "Indian, Pakistani or Bangladeshi")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Pakistani", "Indian, Pakistani or Bangladeshi")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Bangladeshi", "Indian, Pakistani or Bangladeshi")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="African", "Black African")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Any other Asian background", "Asian Other")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Any other Black background", "Black Other")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Any other White background", "White Other")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Any other ethnic group", "Other")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Any other mixed background", "Mixed/Multiple")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Caribbean", "Black Caribbean")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Chinese", "Asian Other")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Not known e.g. unconscious", "Unknown Ethnicity")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="Not stated e.g. unwilling to state
", "Unknown Ethnicity")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="White Irish", "White Other")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="White and Asian", "Mixed/Multiple")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="White and Black African", "Mixed/Multiple")) %>%
  mutate(Eth_ECDScategory = replace(Eth_ECDScategory, Eth_ECDScategory=="White and Black Caribbean", "Mixed/Multiple")) %>%
  mutate(Eth_ECDScategorycategory = if_else(
    (is.na(Eth_ECDScategory) |
       Eth_ECDScategory == "Unknown"),
    "Unknown Ethnicity'",
    Eth_ECDScategory,
    Eth_ECDScategory)) %>% 
  mutate(Eth_ECDScategory = if_else(
    is.na(Eth_ECDScategory), 
    "Unknown Ethnicity", 
    Eth_ECDScategory, 
    Eth_ECDScategory))


HCV_DIAG_SENTINEL$Eth_ECDScategory <- ifelse(HCV_DIAG_SENTINEL$Eth_ECDScategory =="Not stated e.g. unwilling to state

",'Unknown Ethnicity',HCV_DIAG_SENTINEL$Eth_ECDScategory)
HCV_DIAG_SENTINEL$Eth_ECDScategory <- ifelse(HCV_DIAG_SENTINEL$Eth_ECDScategory =="Not known e.g. unconscious
",'Unknown Ethnicity',HCV_DIAG_SENTINEL$Eth_ECDScategory)



#rename column to match mastertable for aggregation function 
names(HCV_DIAG_SENTINEL)[names(HCV_DIAG_SENTINEL)=='Eth_ECDScategory']<- 'ethnic_group'
HCV_DIAG_SENTINEL$ethnic_group <- ifelse(HCV_DIAG_SENTINEL$ethnic_group =="Not stated e.g. unwilling to state",'Unknown Ethnicity',HCV_DIAG_SENTINEL$ethnic_group)


# Rename IMD
HCV_DIAG_SENTINEL <- HCV_DIAG_SENTINEL %>% 
  mutate(IMD = replace(IMD,IMD== 1, "1")) %>% 
  mutate(IMD = replace(IMD,IMD== 2, "1")) %>% 
  mutate(IMD = replace(IMD,IMD== 3, "2")) %>%
  mutate(IMD = replace(IMD,IMD== 4, "2")) %>%
  mutate(IMD = replace(IMD,IMD== 5, "3")) %>%
  mutate(IMD = replace(IMD,IMD== 6, "3")) %>%
  mutate(IMD = replace(IMD,IMD== 7, "4")) %>%
  mutate(IMD = replace(IMD,IMD== 8, "4")) %>%
  mutate(IMD = replace(IMD,IMD== 9, "5")) %>%
  mutate(IMD = replace(IMD,IMD== 10, "5")) %>% 
  mutate(IMD = if_else(
    is.na(IMD), 
    "Unknown IMD", 
    IMD, 
    IMD)) %>% 
  mutate(All = case_when(age >= 0 ~ "All")) %>%
  mutate(agegroup = str_replace_all(agegroup, "-", " to "),
         agegroup = str_replace_all(agegroup, "80\\+", "80 and over"),
         agegroup = str_replace_all(agegroup, "(\\d+)(to)(\\d+)", "\\1 to \\3"))


HCV<- HCV_DIAG_SENTINEL
HCV <- HCV %>%  rowwise() %>%  mutate(GPSatus = ifelse(!is.na(RegisterGP),'yes','No'))

 
  HCV <- HCV %>%
  mutate(any_risk = case_when(
    !is.na(GPSatus) & GPSatus == "No" ~ "Yes",
    !is.na(GPSatus) & GPSatus == "Yes" ~ "No",
    !is.na(homelessflag) & homelessflag == "Yes" ~ "Yes",
    is.na(homelessflag) ~ "No",
    TRUE ~ "No"  # Default case if none of the above conditions are met
  ))
 
  
   ## define the variables you want to loop through for master table
vec <- c("Gender", "ethnic_group", "IMD")

  HCV_pos <- HCV %>%
  filter(
    !is.na(antiHCV) & antiHCV == 'Positive' |
    !is.na(HCVAg) & HCVAg == 'Positive' |
    !is.na(HCVRNA) & HCVRNA == 'Positive'
  )
 
  HCV_pos <- HCV_pos %>%
  pivot_longer(cols = all_of(vec), names_to = "variable", values_to = "value")


# Create the ggplot with the reshaped dataframe
ggplot(HCV_pos, aes(x = any_risk, y = value)) +
  geom_col(fill = "#00414d") +
  labs(x = "Proportion of blood test who had an HIV test (%)", y = "") +
  scale_y_discrete(
    limits = c("5", "4", "3", "2", "1", "NA", "White Other", "White British",
               "Other", "Mixed/Multiple", "Indian, Pakistani or Bangladeshi",
               "Black Other", "Black Caribbean", "Black African", "Asian Other", "NA",
               "80 and over", "65 to 79", "50 to 64", "35 to 49", "25 to 34",
               "16 to 24", "NA", "Men", "Women"),
    labels = c("IMD quintile 5: least deprived", "4", "3", "2", "IMD quintile 1: most deprived", "", "White other", "White British",
               "Other", "Mixed or multiple", "Indian, Pakistani or Bangladeshi",
               "Black other", "Black Caribbean", "Black African", "Asian other", "",
               "80 and over", "65 to 79", "50 to 64", "35 to 49", "25 to 34",
               "16 to 24", "", "Men", "Women")
  ) +
  scale_x_continuous(expand = c(0,0)) +
  theme_minimal() + # Replace with theme_ukhsa if you have it defined
  theme(
    axis.title = element_text(face = "bold"),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "#e0e0e0")
  )

 
```





































































[insert coverage of Age]



[insert coverage of gender ]


[insert coverage of IMD]



[insert coverage of ehtnicity]



Homelessness is defined as: 

xxxxxxxxx



Definition 1: imd


```{r}


ggplot(ED24, aes(x = IMD_ECDS)) +
    geom_bar() +
    labs(
         x = "IMD",
         y = "Number of attendees") +
    theme_minimal()+
   facet_wrap(~Hospital)

# Calculate the percentage of each category
HCV_IMD_percent <- ED24 %>%
  dplyr::count(IMD_ECDS) %>%
  dplyr::mutate(perc_IMD = n / sum(n) * 100)

# Create the bar plot
ggplot(HCV_IMD_percent, aes(x = IMD_ECDS, y = perc_IMD)) +
  geom_bar(stat = "identity") +
  labs( x = "IMD",
       y = "Percentage") +
  theme_minimal()

```

```{r}
ggplot(ED24, aes(x = homelessflag)) +
    geom_bar() +
    labs(
         x = "Homeless",
         y = "Number of attendees") +
    theme_minimal()


ggplot(ED24, aes(x = homelessflag)) +
    geom_bar() +
    labs(
         x = "Homeless",
         y = "Number of attendees") +
    theme_minimal()+
   facet_wrap(~Hospital)

# Calculate the percentage of each category
HCV_homeless_percent <- ED24 %>%
  dplyr::count(homelessflag) %>%
  dplyr::mutate(perc_homeless = n / sum(n) * 100)

# Create the bar plot
ggplot(HCV_homeless_percent, aes(x = homelessflag, y = perc_homeless)) +
  geom_bar(stat = "identity") +
  labs( x = "Homeless",
       y = "Percentage") +
  theme_minimal()
 
```







```{r}

ggplot(ED24, aes(x = testedindrugservice)) +
    geom_bar() +
    labs(
         x = "Drug service",
         y = "Number of attendees") +
    theme_minimal()

# Calculate the percentage of each category
HCV_drugservice_percent <- ED24 %>%
  dplyr::count(testedindrugservice) %>%
  dplyr::mutate(perc_drugservice = n / sum(n) * 100)

# Create the bar plot
ggplot(HCV_drugservice_percent, aes(x = testedindrugservice, y = perc_drugservice)) +
  geom_bar(stat = "identity") +
  labs( x = "Drug service",
       y = "Percentage") +
  theme_minimal()
```
```{r}

ggplot(ED24, aes(x = testedinaprison)) +
    geom_bar() +
    labs(
         x = "Prison",
         y = "Number of attendees") +
    theme_minimal()

# Calculate the percentage of each category
HCV_prison_percent <- ED24 %>%
  dplyr::count(testedinaprison) %>%
  dplyr::mutate(perc_prison = n / sum(n) * 100)

# Create the bar plot
ggplot(HCV_prison_percent, aes(x = testedinaprison, y = perc_prison)) +
  geom_bar(stat = "identity") +
  labs( x = "Prison",
       y = "Percentage") +
  theme_minimal()
```



```{r}

ggplot(ED24, aes(x = PWID_2)) +
    geom_bar() +
    labs(
         x = "PWID_2",
         y = "Number of attendees") +
    theme_minimal()

# Calculate the percentage of each category
HCV_prison_percent <- ED24 %>%
  dplyr::count(testedinaprison) %>%
  dplyr::mutate(perc_prison = n / sum(n) * 100)

# Create the bar plot
ggplot(HCV_prison_percent, aes(x = testedinaprison, y = perc_prison)) +
  geom_bar(stat = "identity") +
  labs( x = "Prison",
       y = "Percentage") +
  theme_minimal()
```








```{r}

#proportion PWID /homeless venn diagram in hcv

set_yes_PWID2 <- ED24$PWID_2 =='Yes'
set_yes_homesless <- ED24$homelessflag =='Yes'

sets_hcv <-list(
  yes_PWID2 =which(set_yes_PWID2),
  yes_homesless =which(set_yes_homesless)
)
ggVennDiagram(sets_hcv)+
 # theme(legend.position = "bottom") + # Move the legend to the bottom
  theme(plot.margin = margin(1, 1, 1, 1, "cm")) # Adjust margins if needed



```

```{r}
# 
# #proportion PWID /homeless venn diagram in hbv
# 
# set_yes_PWID2 <- HBV_test$PWID =='Yes'
# set_yes_homesless <- HBV_test$homelessflag =='Yes'
# set_imd1 <- HBV_test$IMD_ECDS =='1'
# set_imd2 <- HBV_test$IMD_ECDS =='2'
# set_imd3 <- HBV_test$IMD_ECDS =='3'
# set_imd4 <- HBV_test$IMD_ECDS =='4'
# set_imd5 <- HBV_test$IMD_ECDS =='5'
# 
# sets_hbv <-list(
#   #yes_PWID2 =which(set_yes_PWID2),
#   yes_homesless =which(set_yes_homesless),
#   imd1 =which(set_imd1),
#   imd2 =which(set_imd2),
#   imd3 =which(set_imd3),
#   imd4 =which(set_imd4),
#   imd5 =which(set_imd5)
# )
# 
# comparison_sets <- list(
#   'homeless' = sets_hbv$yes_homesless,
#   'homeless ∩ imd 1' = intersect(sets_hbv$yes_homesless, sets_hbv$imd1), 
#   'homeless ∩ imd 2' = intersect(sets_hbv$yes_homesless, sets_hbv$imd2), 
#   'homeless ∩ imd 3' = intersect(sets_hbv$yes_homesless, sets_hbv$imd3), 
#   'homeless ∩ imd 4' = intersect(sets_hbv$yes_homesless, sets_hbv$imd4), 
#   'homeless ∩ imd 5' = intersect(sets_hbv$yes_homesless, sets_hbv$imd5) 
# )
# 


```






Then for final data set 



```{r}

# load HCV attendees data from Sentinel
ED242 <- DBI::dbGetQuery(conn = Y006 , statement = "
SELECT *
FROM [Y006_BBV_PID].[dbo].[ED_RP24]
"
)


```




```{r}

ggplot(ED242, aes(x = homelessflag)) +
    geom_bar() +
    labs(
         x = "Homeless",
         y = "Number of attendees") +
    theme_minimal()

ggplot(ED242, aes(x = homelessflag)) +
    geom_bar() +
    labs(
         x = "Homeless",
         y = "Number of attendees") +
    theme_minimal()+
   facet_wrap(~Hospital)

# Calculate the percentage of each category
HCV_homeless_percent2 <- ED242 %>%
  dplyr::count(homelessflag) %>%
  dplyr::mutate(perc_homeless = n / sum(n) * 100)

# Create the bar plot
ggplot(HCV_homeless_percent2, aes(x = homelessflag, y = perc_homeless)) +
  geom_bar(stat = "identity") +
  labs( x = "Homeless",
       y = "Percentage") +
  theme_minimal()
 
```


```{r}

ggplot(ED24, aes(x = PWID_2)) +
    geom_bar() +
    labs(
         x = "PWID_2",
         y = "Number of attendees") +
    theme_minimal()

# Calculate the percentage of each category
HCV_prison_percent <- ED24 %>%
  dplyr::count(testedinaprison) %>%
  dplyr::mutate(perc_prison = n / sum(n) * 100)

# Create the bar plot
ggplot(HCV_prison_percent, aes(x = testedinaprison, y = perc_prison)) +
  geom_bar(stat = "identity") +
  labs( x = "Prison",
       y = "Percentage") +
  theme_minimal()
```



```{r}


homeless_pop <- ED24 %>% filter(homelessflag=='Yes')

ggplot(homeless_pop, aes(x = IMD_ECDS)) +
    geom_bar() +
    labs(
         x = "IMD",
         y = "Number of attendees") +
    theme_minimal()


ggplot(homeless_pop, aes(x = GPSatus)) +
    geom_bar() +
    labs(
         x = "Gp",
         y = "Number of attendees") +
    theme_minimal()


```