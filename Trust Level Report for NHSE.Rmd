---
  title: "Site Level Report for NHSE"
author: "Olaide Adebayo-Clement"
date: "2024-01-02"
output: html_document
editor_options: 
  markdown: 
  wrap: 72
code_folding: hide
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

*Executive Summary*
  
  The Emergency Department Bloodborne Virus (BBV) Opt-Out Testing Programme has demonstrated notable effectiveness in reaching diverse demographics for HIV, HBV, and HCV testing, aligning with goals of equity and inclusiveness.This report provides an overview of demographic breakdown from data derived from the Sentinel 5 sites.

*Testing Uptake Across Ages*: The programme reported higher engagement in testing among middle-aged individuals (25 to 49 years) for all three viruses. Notably, there was a decline in testing uptake in the youngest (16 to 24 years) and oldest (65 years and over) age groups, signaling an opportunity for more focused outreach and education campaigns tailored to these age groups.

*Ethnic Diversity*: The programme's reach across ethnicities has been broad, successfully engaging various groups. However, it was observed that Black African and White Other demographics exhibited higher rates of diagnosis, underscoring the need for culturally specific health initiatives and communication strategies to address and reduce these disparities.

*Gender Dynamics*: While women participated more actively in testing for all BBVs, men were more frequently diagnosed and linked to care, particularly in the case of HCV. This pattern highlights the necessity of developing targeted health interventions that encourage men to participate more actively in testing and follow-up care.

*Socioeconomic Factors*: The distribution of testing and diagnosis rates across different socioeconomic strata showed a relative balance, indicating the programme's effective reach into diverse communities. However, certain variances in the diagnosis rates for HBV and HCV across these strata suggest the need for continued efforts to ensure equitable access to testing and care for all socioeconomic groups.

*Diagnosis and Care Linkage*: There were varied rates of new diagnoses, with notable concentrations in middle-aged populations and specific ethnicities for HCV and HBV. The linkage to care post-diagnosis for HCV was particularly high, showing effective follow-up procedures, especially among middle-aged and male patients.

Overall, the programme has taken significant steps towards equitable and demographically sensitive BBV testing and care. Nevertheless, it recognizes the importance of continued and focused efforts to mitigate existing disparities in testing uptake, diagnosis rates, and subsequent care linkage across different age groups, genders, ethnicities, and socioeconomic backgrounds.


# Setup and Data Loading

```{r data-loading}
options(repos = c(CRAN = "http://cran.rstudio.com"))
if (!require(tidyverse)) install.packages("tidyverse")
if (!require(lubridate)) install.packages("lubridate")
if (!require(readxl)) install.packages("readxl")
if (!require(DBI)) install.packages("DBI")
if (!require(odbc)) install.packages("odbc")
if (!require(arrow)) install.packages("arrow")
if (!require(pacman)) install.packages("pacman")
if (!require(janitor)) install.packages("janitor")
if (!require(gtsummary)) install.packages("gtsummary")
if (!require(scales)) install.packages("scales")
```

```{r setup-plot}
knitr::opts_chunk$set(fig.width=8, fig.height=6)
```

``` {r establish-connections}
# ESTABLISH ODBC CONNECTION WITH DATA
Y006 <- odbc::dbConnect(odbc::odbc(),
                        .connection_string = "driver={SQL Server};server=SQLClusColLK19\\Lake19;
                             database=Y006_BBV_PID;
                             Encrypt=true;trusted_connection=true",
                        timeout = 60,
                        timezone = Sys.timezone(),
                        timezone_out = Sys.timezone())
```

# Load attendees data from Sentinel
``` {r load-data}
# load HIV attendees data from Sentinel
attendees_HIV <- DBI::dbGetQuery(conn = Y006 , statement = "
SELECT *
FROM [Y006_BBV_PID].[dbo].[12mthECDSattendees_included5sitesHIV]
WHERE (arrdate <= '2023-04-07')"
)

# load HCV attendees data from Sentinel
attendees_HCV <- DBI::dbGetQuery(conn = Y006 , statement = "
SELECT *
FROM [Y006_BBV_PID].[dbo].[12mthECDSattendees_included5sitesHCV]
WHERE (arrdate <= '2023-04-07')"
)

# load HBV attendees data from Sentinel
attendees_HBV <- DBI::dbGetQuery(conn = Y006 , statement = "
SELECT *
FROM [Y006_BBV_PID].[dbo].[12mthECDSattendees_included5sitesHBV]
WHERE (arrdate <= '2023-04-07')"
)
```

#HIV
# Data Preparation and Cleaning
```{r HIV-data-cleaning}
attendees_HIV <- attendees_HIV %>% 
  mutate(IMD = if_else(
    is.na(IMD), 
    "Unknown IMD", 
    IMD, 
    IMD),
    Gender = if_else( # Replace Sex with Gender
      is.na(Sex), 
      "Unknown Gender", 
      Sex, 
      Sex),
    ethnic_group = if_else(
      (is.na(ethnic_group) |
         ethnic_group == "Unknown"), 
      "Unknown Ethnicity", 
      ethnic_group,
      ethnic_group)) %>% 
  mutate(All = case_when(age >= 0 ~ "All")) %>%
  mutate(Gender = replace(Gender, Gender=="FEMALE", "Women")) %>% # Replace Female
  mutate(Gender = replace(Gender, Gender=="MALE", "Men")) %>%    # Replace Male
  mutate(age_group = str_replace_all(age_group, "-", " to "),
         age_group = str_replace_all(age_group, "80\\+", "80 and over"),
         age_group = str_replace_all(age_group, "(\\d+)(to)(\\d+)", "\\1 to \\3")) %>%
  mutate(age_group = ifelse(age_group == "16 to 24" & is.na(age_group), "0", age_group))

```         

# Characteristics of Attendees in the 5 included sites for HIV
``` {r HIV-xteristics}
attendees_HIV_1 <- attendees_HIV %>% 
  mutate(
    IMD = if_else(is.na(IMD), "Unknown IMD", as.character(IMD)),
    Gender = if_else(is.na(Sex), "Unknown Gender", as.character(Sex)),
    ethnic_group = if_else(is.na(ethnic_group) | ethnic_group == "Unknown", 
                           "Unknown Ethnicity", as.character(ethnic_group)),
    Gender = case_when(
      Gender == "FEMALE" ~ "Women",
      Gender == "MALE" ~ "Men",
      TRUE ~ Gender
    ),
    age_group = case_when(
      age >= 0 & age <= 24 ~ "16 to 24",
      age >= 25 & age <= 34 ~ "25 to 34",
      age >= 35 & age <= 49 ~ "35 to 49",
      age >= 50 & age <= 64 ~ "50 to 64",
      age >= 65 & age <= 79 ~ "65 to 79",
      age >= 80 ~ "80 and over",
      TRUE ~ "Unknown Age Group"
    )
  ) %>%
  group_by(age_group, Gender, IMD, ethnic_group) %>%
  summarise(Total_Attendees = n(), .groups = 'drop')
ethnic_group_summary2 <- attendees_HIV_1 %>%
  group_by(ethnic_group) %>%
  summarise(Count = n())

# View the first few rows of the processed dataset
head(attendees_HIV_1)
```

# Visualisation 1: Bar Plot of Total Attendees by Age Group
```{r HIV-visual1}
# loading necessary libraries
library(ggplot2)
library(dplyr)
ggplot(attendees_HIV_1, aes(x = age_group, y = Total_Attendees, fill = age_group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HIV Attendees by Age Group",
       x = "Age Group",
       y = "Total Attendees")
```

# Visualisation 2: Bar Plot of Total Attendees by Gender
``` {r HIV-visual2}
attendees_HIV_1 <- attendees_HIV_1 %>% 
  filter(Gender != "Unknown Gender")

ggplot(attendees_HIV_1, aes(x = Gender, y = Total_Attendees, fill = Gender)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HIV Attendees by Gender",
       x = "Gender",
       y = "Total Attendees")

```

# Visualisation 3: Bar Plot of Total Attendees by Ethnic Group
``` {r HIV-visual3}
attendees_HIV_1 <- attendees_HIV_1 %>% 
  filter(ethnic_group != "Unknown Ethnicity", ethnic_group != "Other")

ggplot(attendees_HIV_1, aes(x = ethnic_group, y = Total_Attendees, fill = ethnic_group)) +
  geom_bar(stat = "identity") +
  coord_flip() + 
  theme_minimal() +
  labs(title = "HIV Attendees by Ethnic Group",
       x = "Ethnic Group",
       y = "Total Attendees")
```       
# Visualisation 4: Bar Plot of Total Attendees by IMD
``` {r HIV-visual4}
attendees_HIV_1 <- attendees_HIV_1 %>% 
  filter(IMD != "Unknown IMD")

ggplot(attendees_HIV_1, aes(x = IMD, y = Total_Attendees, fill = IMD)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HIV Attendees by IMD",
       x = "Index of Multiple Deprivation (IMD)",
       y = "Total Attendees")
```
# Reshaping the data for a combined plot for Improved Visualisation of all demographic groups
``` {r HIV-visual5}
library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)
library(forcats)  # For reordering factors

# Reshaping the data for a combined plot
attendees_long <- attendees_HIV_1 %>%
  pivot_longer(cols = -Total_Attendees, names_to = "Demographic", values_to = "Category")

# Drop NA values and unwanted categories before plotting
attendees_long <- attendees_long %>%
  filter(!is.na(Category)) %>%
  filter(!(Category %in% c("Unknown Gender", "Unknown IMD")))

# Reorder the factors within each demographic subgroup
attendees_long <- attendees_long %>%
  mutate(Category = case_when(
    Demographic == "age_group" ~ fct_relevel(Category, 
                                             "16 to 24", "25 to 34", "35 to 49", "50 to 64", 
                                             "65 to 79", "80 and over"),
    Demographic == "ethnic_group" ~ fct_reorder(Category, as.numeric(as.factor(Category))),
    TRUE ~ fct_reorder(Category, Total_Attendees)
  ))

# Improved Visualisation without headers for each demographic subgroup
ggplot(attendees_long, aes(x = Category, y = Total_Attendees)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    strip.text.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Demographic Characteristics of Attendees with a HIV Blood Test",
    x = "Total Attendees",
    y = ""
  ) +
  facet_wrap(~ Demographic, scales = "free_y", ncol = 1) +
  scale_y_continuous(labels = label_number()) 
# Run the plot

```         
*Overview*
  This report synthesizes insights from the demographic characteristics of attendees with a HIV blood test from the sentinel 5 sites. Rather than focusing on the raw numbers, we delve into what these figures represent concerning public health equity and the programme's reach.

*Age-Related Insights*
The age distribution of HIV testing indicates a higher engagement among the middle-aged demographic, with a notable decline in uptake among the youth and the elderly. This pattern suggests that the programme resonates well with individuals who are typically more established in their healthcare routines, whereas younger and older individuals might not recognize their risk or face barriers in accessing testing. From a public health perspective, this calls for age-tailored outreach that raises awareness among the young, who may underestimate their susceptibility, and the elderly, who may face logistical challenges or a lack of targeted information.

*Ethnicity and Cultural Engagement*
The ethnic breakdown of the testing attendees reflects the programme's varied penetration into different communities. The relatively balanced testing figures across ethnic lines suggest an inclusive reach, but they also highlight the need for culturally sensitive health promotion that addresses specific barriers faced by ethnic minorities. For instance, ensuring language-appropriate resources and engaging community leaders can be effective in increasing uptake and addressing health inequalities.

*Gender Dynamics in Health Engagement*
  The higher testing uptake among women compared to men is an encouraging sign of women's proactive engagement with health services within the programme's framework. This phenomenon warrants a deeper look into gender-specific health-seeking behaviors and reinforces the importance of maintaining strategies that encourage all genders to utilise available health services, especially in areas where men traditionally underutilise healthcare resources.

*Socioeconomic Status and Health Accessibility*
  The gradient of testing uptake across socioeconomic strata, with higher numbers in more deprived areas, offers an optimistic view of the programme's ability to reach those often marginalized in healthcare. It underscores the programme's potential as a tool for leveling the healthcare playing field. Ensuring that individuals from all socioeconomic backgrounds have access to HIV testing is crucial in the broader context of public health and social equity.

*Public Health Implications*
  The programme's data provides a window into the effectiveness of health equity strategies in reaching diverse populations. While it shows promising reach, it also underscores the need for continuous improvement in health service delivery tailored to various demographic needs. Strategies that could enhance the programme's impact include targeted education campaigns, mobile testing units for hard-to-reach populations, and partnerships with community organizations to promote testing in a culturally congruent manner.

*Conclusion*
  The demographic characteristics gleaned from the programme's data offer valuable insights for refining approaches to HIV testing. A public health strategy informed by these insights can lead to more equitable healthcare outcomes and bring us closer to the overarching goal of eliminating HIV transmission. Continued monitoring and adaptation of the programme are necessary to ensure it remains responsive to the nuanced needs of the diverse populations it serves.

#Proportion of Attendees in the 5 included sites Tested for HIV by Demographics

# Proportion of Attendees tested by age_group
``` {r HIV-prop1}
proportion_tested_by_age_HIV <- attendees_HIV %>%
  group_by(age_group) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_age_HIV)
```
# Visualisation of Proportion Tested by Age Group
``` {r HIV-prop2}
ggplot(proportion_tested_by_age_HIV, aes(x = age_group, y = Proportion_Tested, fill = age_group)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HIV Tested Attendees by Age Group",
    x = "Age Group",
    y = "Proportion Tested"
  )
```

# Proportion of Attendees tested by Gender
``` {r HIV-prop3}
proportion_tested_by_gender_HIV <- attendees_HIV %>%
  group_by(Gender) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_gender_HIV)
```
# Visualisation of Proportion Tested by Gender
``` {r HIV-prop4}
proportion_tested_by_gender_HIV <- proportion_tested_by_gender_HIV %>% 
  filter(Gender != "Unknown Gender")

ggplot(proportion_tested_by_gender_HIV, aes(x = Gender, y = Proportion_Tested, fill = Gender)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HIV Tested Attendees by Gender",
    x = "Gender",
    y = "Proportion Tested"
  )
```

# Proportion of Attendees tested by Ethnic Group
``` {r HIV-prop5}
proportion_tested_by_ethnic_group_HIV <- attendees_HIV %>%
  group_by(ethnic_group) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_ethnic_group_HIV)
```
# Visualisation of Proportion Tested by Ethnic Group
``` {r HIV-prop6}
proportion_tested_by_ethnic_group_HIV <- proportion_tested_by_ethnic_group_HIV %>% 
  filter(ethnic_group != "Unknown Ethnicity", ethnic_group != "Other")

ggplot(proportion_tested_by_ethnic_group_HIV, aes(x = ethnic_group, y = Proportion_Tested, fill = ethnic_group)) +
  geom_col() +
  coord_flip() +  # Flips the x and y axes
  theme_minimal() +
  labs(
    title = "Proportion of HIV Tested Attendees by Ethnic Group",
    x = "Ethnic Group",
    y = "Proportion Tested"
  )
```
# Proportion of Attendees tested by IMD
``` {r HIV-prop7}
proportion_tested_by_IMD_HIV <- attendees_HIV %>%
  group_by(IMD) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_IMD_HIV)
```
# Visualisation of Proportion Tested by IMD
``` {r HIV-prop8}
proportion_tested_by_IMD_HIV <- proportion_tested_by_IMD_HIV %>% 
  filter(IMD != "Unknown IMD")

ggplot(proportion_tested_by_IMD_HIV, aes(x = IMD, y = Proportion_Tested, fill = IMD)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HIV Tested Attendees by IMD",
    x = "IMD",
    y = "Proportion Tested"
  ) 
```  
# Improved visualisation for proportion of attendees tested for HIV by all demographic groups
``` {r HIV-prop9}
#Combine proportion data frames with an additional column for Demographic
combined_proportions_HIV <- bind_rows(
  mutate(proportion_tested_by_age_HIV, Demographic = "Age Group"),
  mutate(proportion_tested_by_gender_HIV, Demographic = "Gender"),
  mutate(proportion_tested_by_ethnic_group_HIV, Demographic = "Ethnic Group"),
  mutate(proportion_tested_by_IMD_HIV, Demographic = "IMD")
) 

# Pivot only the demographic category columns
combined_proportions_long_HIV <- combined_proportions_HIV %>%
  pivot_longer(cols = c(age_group, Gender, ethnic_group, IMD), 
               names_to = "Category", values_to = "Category_Value", 
               values_drop_na = TRUE) %>%
  filter(!(Category_Value %in% c("Unknown Gender", "Unknown IMD"))) %>%
  select(-Total_Attendees, -Tested_Attendees)  # Remove unnecessary columns

# Improved Visualisation
ggplot(combined_proportions_long_HIV, aes(x = Category_Value, y = Proportion_Tested)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    strip.text.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Proportion of Attendees Tested for HIV by Demographics",
    x = "Demographic Category",
    y = "Proportion Tested (%)"
  ) +
  facet_wrap(~ Category, scales = "free_y", ncol = 1)

# Run the plot

```         


#Percentage Diagnosed by Demographics 
``` {r HIV-diag1}
# Load HIV additional data
# NOTE TO USER: may need to update file path with the letter corresponding to your mapped drive
hiv_additional_data <- read_csv("Y:/Evaluations/ED opt out BBV testing evaluation/Analysis/hiv_indicator_tab_5.csv") %>%
  rename(var = Group, breakdown = "Breakdown type") %>%
  filter(breakdown %in% c("Total", "Age group", "Ethnic group", "IMD quintile", "Gender")) %>%
  mutate(
    breakdown = recode(breakdown, "IMD quintile" = "IMD"),
    var = case_when(
      breakdown == "Gender" & var == "Not known" ~ "Unknown Gender",
      breakdown == "Age group" & var == "Not known" ~ "Unknown Age",
      breakdown == "Ethnic group" & var == "Not known" ~ "Unknown Ethnicity",
      breakdown == "IMD" & var == "Not known" ~ "Unknown IMD",
      var != "Not known" ~ var
    )
  ) %>%
  select(breakdown, var, "Number of patients who test positive for HIV (2022 only)", 
         "Number of patients who test positive for HIV (all)", "New diagnosis (2022 only)") %>%
  mutate(var = recode(var, 
                      "1 (most deprived)" = "1", 
                      "5 (least deprived)" = "5", 
                      "Asian: Indian, Pakistani or Bangladeshi" = "Indian, Pakistani or Bangladeshi", 
                      "Mixed" = "Mixed/Multiple", 
                      "16-24" = "16 to 24", 
                      "25-34" = "25 to 34", 
                      "35-49" = "35 to 49", 
                      "50-64" = "50 to 64", 
                      "65-79" = "65 to 79", 
                      "80+" = "80 and over"
                     )) %>%
  replace(is.na(.), 0)
```  
# Calculating Percentage Diagnosed by Demographics (HIV)
# Percentage Diagnosed by Age group
``` {r HIV-diag2}
percentage_diagnosed_by_age_HIV <- hiv_additional_data %>%
  filter(breakdown == "Age group") %>%
  group_by(var) %>%
  summarise(Total_New_Diagnoses = sum(`New diagnosis (2022 only)`)) %>%
  mutate(Percentage = Total_New_Diagnoses / sum(Total_New_Diagnoses) * 100)
```
# Percentage Diagnosed by Gender
``` {r HIV-diag3}
percentage_diagnosed_by_gender_HIV <- hiv_additional_data %>%
  filter(breakdown == "Gender") %>%
  group_by(var) %>%
  summarise(Total_New_Diagnoses = sum(`New diagnosis (2022 only)`)) %>%
  mutate(Percentage = Total_New_Diagnoses / sum(Total_New_Diagnoses) * 100)
```
# Percentage Diagnosed by IMD
``` {r HIV-diag4}
percentage_diagnosed_by_IMD_HIV <- hiv_additional_data %>%
  filter(breakdown == "IMD") %>%
  group_by(var) %>%
  summarise(Total_New_Diagnoses = sum(`New diagnosis (2022 only)`)) %>%
  mutate(Percentage = Total_New_Diagnoses / sum(Total_New_Diagnoses) * 100)
```
# Percentage Diagnosed by Ethnic Group
``` {r HIV-diag5}
percentage_diagnosed_by_Ethnic_Group_HIV <- hiv_additional_data %>%
  filter(breakdown == "Ethnic group") %>%
  group_by(var) %>%
  summarise(Total_New_Diagnoses = sum(`New diagnosis (2022 only)`)) %>%
  mutate(Percentage = Total_New_Diagnoses / sum(Total_New_Diagnoses) * 100)
```
# Combine all demographic data frames  for improved visualisation of all demographic variables
``` {r HIV-diag6}
combined_hiv_percentage <- bind_rows(
  percentage_diagnosed_by_age_HIV %>% mutate(Demographic = "Age Group"),
  percentage_diagnosed_by_gender_HIV %>% mutate(Demographic = "Gender"),
  percentage_diagnosed_by_IMD_HIV %>% mutate(Demographic = "IMD"),
  percentage_diagnosed_by_Ethnic_Group_HIV %>% mutate(Demographic = "Ethnic Group")
) %>% 
  rename(Category_Value = var)

# Visualization
# Filter out the 'Unknown' categories
filtered_hiv_percentage <- combined_hiv_percentage %>%
  filter(!Category_Value %in% c("Unknown Age", "Unknown Gender", "Other", "Unknown Ethnicity", "Unknown IMD"))

# Visualization using the template
ggplot(filtered_hiv_percentage, aes(x = Category_Value, y = Percentage)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    strip.text.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Percentage of New HIV Diagnoses by Demographics (2022)",
    x = "Demographic Category",
    y = "Percentage (%)"
  ) +
  facet_wrap(~ Demographic, scales = "free_y", ncol = 1) 


```
*Contextual Overview*
The report delves into the distribution of new HIV diagnoses by demographics in 2022, as part of the Emergency Department Bloodborne Virus Opt-Out Testing Programme. The data obtained from the Sentinel 5 sites, presents a compelling narrative about the disease's impact across different segments of the population. The following insights draw attention to the broader public health implications and highlight areas for targeted intervention.

*Age Dynamics in New Diagnoses*
  The data indicates a concentration of new HIV diagnoses among individuals aged 35 to 64, with the highest percentage in the 35 to 49 age bracket. This suggests that middle age groups are at a higher risk of newly identified HIV infections, which could be due to various factors, including lifestyle, the likelihood of being tested, or generational differences in awareness and attitudes towards HIV. The low percentage of new diagnoses among those aged 65 to 79 might reflect lower transmission risk or potentially missed diagnoses due to less frequent testing or symptoms being attributed to other age-related health issues.

*Ethnicity and New HIV Diagnosis Rates*
  The ethnic breakdown of new diagnoses reveals that the White Other and Black African categories bear a higher burden of new HIV infections. The markedly high percentage for White Other individuals could be reflective of various factors, including social behavior, migration patterns, or disparities in health service accessibility and utilization. The significant percentage among Black African individuals aligns with global and national trends, emphasizing the need for culturally sensitive education and testing efforts within these communities.

*Gender Disparity*
  Men account for a substantially higher percentage of new HIV diagnoses compared to women, a disparity that reinforces the global trend where men are more affected by HIV. This could be influenced by both biological factors and differences in health-seeking behavior between men and women. It highlights the importance of promoting HIV testing and prevention strategies among men, and especially in settings and contexts where they are more likely to be reached.

*Socioeconomic Status*
  The socioeconomic status, as inferred from the Index of Multiple Deprivation (IMD) quintiles, shows a higher percentage of new diagnoses in more deprived areas (Quintiles 1 and 2). This finding underscores the association between deprivation and health outcomes and points to the necessity of addressing the social determinants of health in HIV prevention strategies.

*Public Health Outlook*
  From a public health perspective, these demographics point towards the need for nuanced, tailored public health interventions. Strategies such as increasing access to preventative services, expanding education on safe practices, and facilitating early testing can significantly impact the demographics most at risk. Furthermore, initiatives must be mindful of the stigma and discrimination that can be associated with HIV, which can deter individuals from seeking testing and treatment.

*Concluding Insights*
  The demographic patterns of new HIV diagnoses within the Emergency Department Bloodborne Virus Opt-Out Testing Programme provide critical insights into where resources and prevention efforts could be most effectively deployed. An intersectional approach that considers age, ethnicity, gender, and socioeconomic status is vital to reducing new HIV infections and promoting health equity. Public health efforts must continue to adapt and respond to these insights, ensuring that all populations have the knowledge, means, and support to prevent HIV transmission.

#HCV
#Data Processing and Cleaning
``` {r HCV-data-cleaning}
attendees_HCV <- attendees_HCV %>% 
  mutate(IMD = if_else(
    is.na(IMD), 
    "Unknown IMD", 
    IMD, 
    IMD),
    Gender = if_else( # Replace Sex with Gender
      is.na(Sex), 
      "Unknown Gender", 
      Sex, 
      Sex),
    ethnic_group = if_else(
      (is.na(ethnic_group) |
         ethnic_group == "Unknown"), 
      "Unknown Ethnicity", 
      ethnic_group,
      ethnic_group)) %>% 
  mutate(All = case_when(age >= 0 ~ "All")) %>%
  mutate(Gender = replace(Gender, Gender=="FEMALE", "Women")) %>% # Replace Female
  mutate(Gender = replace(Gender, Gender=="MALE", "Men")) %>%    # Replace Male
  mutate(age_group = str_replace_all(age_group, "-", " to "),
         age_group = str_replace_all(age_group, "80\\+", "80 and over"),
         age_group = str_replace_all(age_group, "(\\d+)(to)(\\d+)", "\\1 to \\3")) %>%
  mutate(age_group = ifelse(age_group == "16 to 24" & is.na(age_group), "0", age_group))


```  
# Characteristics of Attendees in the 5 included sites for HCV
``` {r HCV-xteristics1}
attendees_HCV_1 <- attendees_HCV %>% 
  mutate(
    IMD = if_else(is.na(IMD), "Unknown IMD", as.character(IMD)),
    Gender = if_else(is.na(Sex), "Unknown Gender", as.character(Sex)),
    ethnic_group = if_else(is.na(ethnic_group) | ethnic_group == "Unknown", 
                           "Unknown Ethnicity", as.character(ethnic_group)),
    Gender = case_when(
      Gender == "FEMALE" ~ "Women",
      Gender == "MALE" ~ "Men",
      TRUE ~ Gender
    ),
    age_group = case_when(
      age >= 0 & age <= 24 ~ "16 to 24",
      age >= 25 & age <= 34 ~ "25 to 34",
      age >= 35 & age <= 49 ~ "35 to 49",
      age >= 50 & age <= 64 ~ "50 to 64",
      age >= 65 & age <= 79 ~ "65 to 79",
      age >= 80 ~ "80 and over",
      TRUE ~ "Unknown Age Group"
    )
  ) %>%
  group_by(age_group, Gender, IMD, ethnic_group) %>%
  summarise(Total_Attendees = n(), .groups = 'drop')
# View the first few rows of the processed dataset
head(attendees_HCV_1)
```


# Visualisation 1: Bar Plot of Total Attendees by Age Group
``` {r HCV-xteristics2}
ggplot(attendees_HCV_1, aes(x = age_group, y = Total_Attendees, fill = age_group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HCV Attendees by Age Group",
       x = "Age Group",
       y = "Total Attendees")
```       
# Visualisation 2: Bar Plot of Total Attendees by Gender
``` {r HCV-xteristics3}
attendees_HCV_1 <- attendees_HCV_1 %>% 
  filter(Gender != "Unknown Gender")

ggplot(attendees_HCV_1, aes(x = Gender, y = Total_Attendees, fill = Gender)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HCV Attendees by Gender",
       x = "Gender",
       y = "Total Attendees")
```

# Visualisation 3: Bar Plot of Total Attendees by Ethnic Group
``` {r HCV-xteristics4}
attendees_HCV_1 <- attendees_HCV_1 %>% 
  filter(ethnic_group != "Unknown Ethnicity", ethnic_group != "Other")

ggplot(attendees_HCV_1, aes(x = ethnic_group, y = Total_Attendees, fill = ethnic_group)) +
  geom_bar(stat = "identity") + 
  coord_flip() + 
  theme_minimal() +
  labs(title = "HCV Attendees by Ethnic Group",
       x = "Ethnic Group",
       y = "Total Attendees")
```       
# Visualisation 4: Bar Plot of Total Attendees by IMD
``` {r HCV-xteristics5}
attendees_HCV_1 <- attendees_HCV_1 %>% 
  filter(IMD != "Unknown IMD")

ggplot(attendees_HCV_1, aes(x = IMD, y = Total_Attendees, fill = IMD)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HCV Attendees by IMD",
       x = "Index of Multiple Deprivation (IMD)",
       y = "Total Attendees")
```
# Reshaping the data for a combined plot for an improved visualisation of all Demographic groups
``` {r HCV-xteristics6}
# Reshaping the data for a combined plot
attendees_long_HCV <- attendees_HCV_1 %>%
  pivot_longer(cols = -Total_Attendees, names_to = "Demographic", values_to = "Category")

# Drop NA values and unwanted categories before plotting
attendees_long_HCV <- attendees_long_HCV %>%
  filter(!is.na(Category)) %>%
  filter(!(Category %in% c("Unknown Gender", "Unknown IMD")))

# Reorder the factors within each demographic subgroup
attendees_long_HCV <- attendees_long_HCV %>%
  mutate(Category = case_when(
    Demographic == "age_group" ~ fct_relevel(Category, 
                                             "16 to 24", "25 to 34", "35 to 49", "50 to 64", 
                                             "65 to 79", "80 and over"),
    Demographic == "ethnic_group" ~ fct_reorder(Category, as.numeric(as.factor(Category))),
    TRUE ~ fct_reorder(Category, Total_Attendees)
  ))

# Improved Visualisation for each demographic subgroup
ggplot(attendees_long_HCV, aes(x = Category, y = Total_Attendees)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +  # Set uniform bar color
  coord_flip() +  # Flip coordinates to make horizontal bar chart
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),  # Remove y-axis title for cleaner look
    axis.text.y = element_text(size = 10),  # Adjust text size for better readability
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),  # Center the plot title
    strip.text.x = element_blank(),  # Remove the text for facet labels
    strip.background = element_blank(),  # Remove background for facet labels
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),  # Lighter grid lines
    panel.grid.major.y = element_blank(),  # No horizontal grid lines
    panel.spacing = unit(1, "lines")  # Increase spacing between facets
  ) +
  labs(
    title = "Demographic Characteristics of Attendees with a HCV Blood Test",
    x = "Total Attendees",
    y = ""  # Since we're flipping the coordinates, x and y axis labels are swapped
  ) +
  facet_wrap(~ Demographic, scales = "free_y", ncol = 1)   # Facet by Demographic

# Run the plot

```
*Overview*
  The demographic characteristics of attendees with a Hepatitis C Virus (HCV) test within the Emergency Department Bloodborne Virus Opt-Out Testing Programme, sheds light on the reach and inclusivity of this public health initiative. Here, we interpret the significance of the testing data in relation to equity and demographic diversity.

*Demographic Insights*
  The distribution of Hepatitis C Virus (HCV) testing across age groups within the Emergency Department Opt-Out Programme reveals a pronounced uptake among individuals in their late adulthood (25 to 49 years), signaling a potential alignment of testing initiatives with the risk profiles and healthcare engagement levels of this demographic. The lower testing uptake in the youngest (16 to 24) and senior populations (65 and over) suggests a disconnection that might stem from a combination of lower perceived risk, less healthcare interaction, or possibly a generational gap in health literacy regarding HCV.

*Ethnic Diversity in Testing*
  The programme's reach across ethnic groups highlights both successes and areas for improvement. While significant numbers of White British and Indian, Pakistani, or Bangladeshi individuals have been tested, indicating effective penetration in these communities, the testing rates for Black Caribbean, Mixed/Multiple, and Other ethnicities point to the necessity of culturally-tailored health interventions. The substantial portion of tests among individuals of unspecified ethnicity underscores the imperative for more precise demographic data capture, critical for refining public health strategies.

*Gender Dynamics*
The higher testing figures for women compared to men challenge traditional healthcare narratives, suggesting that the programme's messaging and services have effectively mobilized women to engage in HCV testing. This trend necessitates a dynamic approach to engage men more robustly, potentially by leveraging male-oriented communication channels and addressing gender-specific barriers to healthcare.

*Socioeconomic Patterns*
  An analysis of testing uptake through the lens of socioeconomic status reveals a nuanced pattern. While there is a relatively equitable spread of testing across different levels of deprivation, there is a subtle yet noticeable decline in testing from the most deprived (Quintile 1) to the least deprived (Quintile 5) areas. This pattern may reflect a targeted approach where the programme effectively reaches populations at higher risk of HCV exposure due to socioeconomic factors.

*Dynamic Insights for Public Health*
  The programme's demographic data presents a multi-faceted view of HCV testing engagement that is vital for public health planning. It calls for a dynamic, responsive approach to health education and testing services that considers age-specific health behaviors, cultural competencies in health promotion, and gender-focused engagement strategies. Furthermore, it emphasizes the significance of robust data collection systems that can capture the full spectrum of demographic information to inform public health policies and eliminate health disparities in HCV testing and subsequent care access.


#Proportion of Attendees in the 5 included sites Tested for HCV by Demographics

# Proportion of Attendees tested by age_group
``` {r HCV-prop1}
proportion_tested_by_age_HCV <- attendees_HCV %>%
  group_by(age_group) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_age_HCV)
```
# Visualisation of Proportion Tested by Age Group
``` {r HCV-prop2}
ggplot(proportion_tested_by_age_HCV, aes(x = age_group, y = Proportion_Tested, fill = age_group)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HCV Tested Attendees by Age Group",
    x = "Age Group",
    y = "Proportion Tested"
  )
```

# Proportion of Attendees tested by Gender
``` {r HCV-prop3}
proportion_tested_by_gender_HCV <- attendees_HCV %>%
  group_by(Gender) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_gender_HCV)
```
# Visualisation of Proportion Tested by Gender
``` {r HCV-prop4}
proportion_tested_by_gender_HCV <- proportion_tested_by_gender_HCV %>% 
  filter(Gender != "Unknown Gender")

ggplot(proportion_tested_by_gender_HCV, aes(x = Gender, y = Proportion_Tested, fill = Gender)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HCV Tested Attendees by Gender",
    x = "Gender",
    y = "Proportion Tested"
  )
```

# Proportion of Attendees tested by Ethnic Group
``` {r HCV-prop5}
proportion_tested_by_ethnic_group_HCV <- attendees_HCV %>%
  group_by(ethnic_group) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_ethnic_group_HCV)
```
# Visualisation of Proportion Tested by Ethnic Group
``` {r HCV-prop6}
proportion_tested_by_ethnic_group_HCV <- proportion_tested_by_ethnic_group_HCV %>% 
  filter(ethnic_group != "Unknown Ethnicity", ethnic_group != "Other")

ggplot(proportion_tested_by_ethnic_group_HCV, aes(x = ethnic_group, y = Proportion_Tested, fill = ethnic_group)) +
  geom_col() + 
  coord_flip() + 
  theme_minimal() +
  labs(
    title = "Proportion of HCV Tested Attendees by Ethnic Group",
    x = "Ethnic Group",
    y = "Proportion Tested"
  )
```
# Proportion of Attendees tested by IMD
``` {r HCV-prop7}
proportion_tested_by_IMD_HCV <- attendees_HCV %>%
  group_by(IMD) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_IMD_HCV)
```
# Visualisation of Proportion Tested by IMD
``` {r HCV-prop8}
proportion_tested_by_IMD_HCV <- proportion_tested_by_IMD_HCV %>% 
  filter(IMD != "Unknown IMD")

ggplot(proportion_tested_by_IMD_HCV, aes(x = IMD, y = Proportion_Tested, fill = IMD)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HCV Tested Attendees by IMD",
    x = "IMD",
    y = "Proportion Tested"
  )
```  
# Combine proportion data frames with an additional column forimproved visualisation for all Demographic groups
``` {r HCV-prop9}
combined_proportions_HCV <- bind_rows(
  mutate(proportion_tested_by_age_HCV, Demographic = "Age Group"),
  mutate(proportion_tested_by_gender_HCV, Demographic = "Gender"),
  mutate(proportion_tested_by_ethnic_group_HCV, Demographic = "Ethnic Group"),
  mutate(proportion_tested_by_IMD_HCV, Demographic = "IMD")
) 

# Pivot only the demographic category columns
combined_proportions_long_HCV <- combined_proportions_HCV %>%
  pivot_longer(cols = c(age_group, Gender, ethnic_group, IMD), 
               names_to = "Category", values_to = "Category_Value", 
               values_drop_na = TRUE) %>%
  filter(!(Category_Value %in% c("Unknown Gender", "Unknown IMD"))) %>%
  select(-Total_Attendees, -Tested_Attendees)  # Remove unnecessary columns

# Improved Visualisation
ggplot(combined_proportions_long_HCV, aes(x = Category_Value, y = Proportion_Tested)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    strip.text.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Proportion of Attendees Tested for HCV by Demographics",
    x = "Demographic Category",
    y = "Proportion Tested (%)"
  ) +
  facet_wrap(~ Category, scales = "free_y", ncol = 1) 
# Run the plot
```

# Calculating Percentage Diagnosed by Demographics
# Data Preparation and Cleaning
``` {r HCV-diag1}
attendees_HCVRNApos <- attendees_HCV %>% filter(rna_positive_new == "New") %>% 
  mutate(IMD = if_else(
    is.na(IMD), 
    "Unknown IMD", 
    IMD, 
    IMD),
    Gender = if_else( # Replace Sex with Gender
      is.na(Sex), 
      "Unknown Gender", 
      Sex, 
      Sex),
    ethnic_group = if_else(
      (is.na(ethnic_group) |
         ethnic_group == "Unknown"), 
      "Unknown Ethnicity", 
      ethnic_group,
      ethnic_group)) %>% 
  mutate(All = case_when(age >= 0 ~ "All")) %>%
  mutate(Gender = replace(Gender, Gender=="FEMALE", "Women")) %>% # Replace Female
  mutate(Gender = replace(Gender, Gender=="MALE", "Men")) %>%    # Replace Male
  mutate(age_group = str_replace_all(age_group, "-", " to "),
         age_group = str_replace_all(age_group, "80\\+", "80 and over"),
         age_group = str_replace_all(age_group, "(\\d+)(to)(\\d+)", "\\1 to \\3")) %>%
  mutate(age_group = ifelse(age_group == "16 to 24" & is.na(age_group), "0", age_group))
```
# Percentage Diagnosed by Age group
``` {r HCV-diag2}
percentage_diagnosed_by_age_HCV <- attendees_HCVRNApos %>%
  group_by(age_group) %>% 
                        summarise(Count = n()) %>% 
                        mutate(Percentage = Count / sum(Count) * 100)
```
# Visualisation of Percentage Diagnosed by Age group
``` {r HCV-diag3}
ggplot(percentage_diagnosed_by_age_HCV, aes(x = age_group, y = Percentage, fill = age_group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Percentage of Diagnosed HCV Patients by Age Group", x = "Age Group", y = "Percentage")
```
# Percentage Diagnosed by Gender
``` {r HCV-diag4}
percentage_diagnosed_by_gender_HCV <- attendees_HCVRNApos %>% 
                  group_by(Gender) %>% 
                  summarise(Count = n()) %>% 
                  mutate(Percentage = Count / sum(Count) * 100)
```
# Visualisation of Percentage Diagnosed by Gender
``` {r HCV-diag5}
ggplot(percentage_diagnosed_by_gender_HCV, aes(x = Gender, y = Percentage, fill = Gender)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Percentage of Diagnosed HCV Patients by Gender", x = "Gender", y = "Percentage")
```       
# Percentage Diagnosed by IMD
``` {r HCV-diag6}
percentage_diagnosed_by_IMD_HCV <- attendees_HCVRNApos %>% 
                  group_by(IMD) %>% 
                  summarise(Count = n()) %>% 
                  mutate(Percentage = Count / sum(Count) * 100)
```
# Visualisation of Percentage Diagnosed by IMD
``` {r HCV-diag7}
proportion_tested_by_IMD_HCV <- proportion_tested_by_IMD_HCV %>% 
  filter(IMD != "Unknown IMD")

ggplot(proportion_tested_by_IMD_HCV, aes(x = IMD, y = Proportion_Tested, fill = IMD)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HCV Tested Attendees by IMD",
    x = "IMD",
    y = "Proportion Tested"
  )
```
# Percentage Diagnosed by Ethnic Group
``` {r HCV-diag8}
percentage_diagnosed_by_Ethnic_Group_HCV <- attendees_HCVRNApos %>% 
                           group_by(ethnic_group) %>% 
                           summarise(Count = n()) %>% 
                           mutate(Percentage = Count / sum(Count) * 100)
```
# Visualisation of Percentage Diagnosed by Ethnic Group
``` {r HCV-diag9}
percentage_diagnosed_by_Ethnic_Group_HCV <- percentage_diagnosed_by_Ethnic_Group_HCV %>% 
  filter(ethnic_group != "Unknown Ethnicity", ethnic_group != "Other")

ggplot(percentage_diagnosed_by_Ethnic_Group_HCV, aes(x = ethnic_group, y = Percentage, fill = ethnic_group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  coord_flip() +
  labs(
    title = "Percentage of Diagnosed HCV Patients by Ethnic Group",
    x = "Ethnic Group",
    y = "Percentage"
  )
```
# Combine the percentage diagnosed data frames for improved visualisation for all demographic groups
``` {r HCV-diag10}
# Reshape and combine all demographic data frames
combined_percentage_diagnosed_long_HCV <- bind_rows(
  percentage_diagnosed_by_age_HCV %>% mutate(Demographic = "Age Group") %>% rename(Category_Value = age_group),
  percentage_diagnosed_by_gender_HCV %>% mutate(Demographic = "Gender") %>% rename(Category_Value = Gender),
  percentage_diagnosed_by_IMD_HCV %>% mutate(Demographic = "IMD") %>% rename(Category_Value = IMD),
  percentage_diagnosed_by_Ethnic_Group_HCV %>% mutate(Demographic = "Ethnic Group") %>% rename(Category_Value = ethnic_group)
) %>% 
  select(Demographic, Category_Value, Percentage = Percentage)

# Filter out "Unknown IMD" from the dataset
combined_percentage_diagnosed_long_HCV <- combined_percentage_diagnosed_long_HCV %>% 
  filter(!(Demographic == "IMD" & Category_Value == "Unknown IMD"))

# Visualisation
# Improved Visualisation
ggplot(combined_percentage_diagnosed_long_HCV, aes(x = Category_Value, y = Percentage)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    strip.text.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Percentage Diagnosed with HCV by Demographics",
    x = "Demographic Category",
    y = "Percentage Diagnosed (%)"
  ) +
  facet_wrap(~ Demographic, scales = "free_y", ncol = 1) 

# Run the plot
```
*Overview*
The distribution of Hepatitis C Virus (HCV) diagnoses by demographics from the Sentinel 5 sites reveals distinct patterns that are key to understanding the virus's impact and the effectiveness of testing strategies across different population segments.

*Age Group Analysis*
  The most significant percentages of HCV diagnoses are found in the age groups of 35 to 64, accounting for over two-thirds of the diagnoses. This finding reflects common risk factor profiles, such as the historical use of non-sterile medical equipment or high-risk behaviors that may have occurred decades prior, given HCV's long asymptomatic period. The notable percentage in individuals aged 65 to 79 suggests that HCV can remain undetected until later in life, possibly due to less frequent testing or recognition of symptoms. The absence of data for the 16 to 24 age group could either reflect a low incidence rate or a gap in testing coverage for this demographic.

*Ethnicity and HCV Diagnoses*
The distribution among ethnic groups shows a higher diagnosis percentage in the White Other and White British categories. This could be indicative of both the prevalence of HCV in these groups and their relative engagement with the testing programme. Conversely, the lower percentages in Black African, Black Caribbean, and Mixed/Multiple ethnicities highlight the need for culturally adapted public health strategies to improve diagnosis rates and ensure equitable healthcare access.

*Gender Disparities*
Men represent a higher percentage of new diagnoses than women, suggesting that men may be at greater risk for HCV or that they engage differently with health services that lead to a diagnosis. This underscores the necessity for gender-sensitive health interventions that encourage testing and address potential stigma or misconceptions about HCV.

*Socioeconomic Status*
Socioeconomic status, as depicted by IMD quintiles, shows a higher proportion of new diagnoses in the most deprived areas. This gradient underscores the interplay between HCV and socioeconomic factors, necessitating targeted interventions in more deprived communities to address the underlying risk factors contributing to HCV transmission.

*Public Health Implications*
These demographics underline the need for a multifaceted approach to HCV testing and diagnosis. There is a clear necessity for ongoing public health efforts to emphasize age-appropriate screening, particularly among older populations, and for strategies that account for the complex interplay of ethnicity, gender, and socioeconomic status in HCV transmission and diagnosis.

*Conclusion*
The presented data points to significant demographic disparities in new HCV diagnoses. Addressing these through tailored, culturally competent, and gender-responsive public health initiatives will be crucial in mitigating the spread of HCV and ensuring that all individuals, regardless of background, have equal access to diagnosis and care.


#Percentage of Patients diagnosed with HCV Linked to Care by Demographics

# Load HCV 'Link to care' data
``` {r HCV-link1}
attendees_HCV_linked <- attendees_HCV %>% filter(LinkedtoRx == "Yes")
```
# Calculating the percentage linked to care by demographics
# Percentage Linked to Care by Age Group
``` {r HCV-link2}
HCV_percentage_linked_age <- attendees_HCV_linked %>% 
  group_by(age_group) %>% 
  summarise(Count = n()) %>% 
  mutate(Percentage = Count / nrow(attendees_HCV_linked) * 100)
```
# Percentage Linked to Care by Gender
``` {r HCV-link3}
HCV_percentage_linked_gender <- attendees_HCV_linked %>% 
  group_by(Gender) %>% 
  summarise(Count = n()) %>% 
  mutate(Percentage = Count / nrow(attendees_HCV_linked) * 100)
```
# Percentage Linked to Care by IMD
``` {r HCV-link4}
HCV_percentage_linked_IMD <- attendees_HCV_linked %>% 
  group_by(IMD) %>% 
  summarise(Count = n()) %>% 
  mutate(Percentage = Count / nrow(attendees_HCV_linked) * 100)
```
# Percentage Linked to Care by Ethnic Group
``` {r HCV-link5}
HCV_percentage_linked_ethnic_group <- attendees_HCV_linked %>% 
  group_by(ethnic_group) %>% 
  summarise(Count = n()) %>% 
  mutate(Percentage = Count / nrow(attendees_HCV_linked) * 100)
```  
# Combine all demographic data frames for improved visualisation of all demographic groups
``` {r HCV-link6}
# Combine the data frames and create a 'Demographic' column
HCV_combined_linked_percentage <- bind_rows(
  HCV_percentage_linked_age %>% mutate(Demographic = "Age Group") %>% rename(Category_Value = age_group),
  HCV_percentage_linked_gender %>% mutate(Demographic = "Gender") %>% rename(Category_Value = Gender),
  HCV_percentage_linked_IMD %>% mutate(Demographic = "IMD") %>% rename(Category_Value = IMD),
  HCV_percentage_linked_ethnic_group %>% mutate(Demographic = "Ethnic Group") %>% rename(Category_Value = ethnic_group)
) %>% 
  select(Demographic, Category_Value, Percentage)

# Filter out "Unknown IMD", "Unknown Ethnicity" and "Other" from the dataset
HCV_combined_linked_percentage <- HCV_combined_linked_percentage %>% 
  filter(!(Demographic == "IMD" & Category_Value == "Unknown IMD")) %>%
  filter(!(Demographic == "Ethnic Group" & (Category_Value %in% c("Unknown Ethnicity", "Other"))))

# Visualisation of percentage linked to care by demographics
ggplot(HCV_combined_linked_percentage, aes(x = Category_Value, y = Percentage, fill = Demographic)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    strip.text.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Percentage of HCV Patients Linked to Care by Demographics",
    x = "Demographic Category",
    y = "Percentage Linked to Care (%)"
  ) +
  facet_wrap(~ Demographic, scales = "free_y", ncol = 1)
  
#Run the plot
```
*Overview*
An analysis of the linkage to care for patients diagnosed with Hepatitis C Virus (HCV) within the Sentinel 5 sites provides critical insights into the post-diagnosis pathway and highlights the intersections of healthcare engagement with demographics.

*Age-Related Care Linkage*
A substantial portion of patients aged 35 to 64 were linked to care, aligning with the higher diagnosis rates in this cohort. Notably, there is a significant care linkage for those aged 50 to 64, suggesting effective follow-up protocols for this demographic, which might be more susceptible to HCV-related complications due to age. The lower linkage rate for the youngest cohort (25 to 34) may suggest challenges in healthcare navigation or lower perceived urgency for treatment. For seniors (65 and over), the moderate to low linkage rates raise concerns about potential barriers to accessing care, such as mobility or complexity of healthcare systems.

*Ethnicity and Access to Care*
The ethnicity-based analysis reveals that White British patients are most likely to be linked to care, possibly reflecting greater healthcare system literacy or access. The relatively high linkage for White Other patients also suggests successful engagement with healthcare services. However, the lower linkage rates among Black African, Black Caribbean, and other ethnic minorities highlight a potential gap in culturally sensitive care coordination and support systems that facilitate access to treatment.

*Gender Dynamics in Healthcare Utilisation*
Men demonstrated a higher likelihood of being linked to care compared to women, a contrast to the global trend of women generally being more engaged with health services. This may indicate that once diagnosed, men are effectively integrated into care pathways or that women face unique barriers post-diagnosis that impede their care linkage.

*Socioeconomic Influences*
The linkage to care across socioeconomic quintiles showcases a relatively even distribution, albeit with a slight decline in the least deprived areas. The data suggests that the programme has had some success in navigating patients from varying socioeconomic backgrounds to care, though continuous efforts are needed to ensure that deprivation does not influence a patient's ability to receive timely treatment.

*Conclusions and Public Health Recommendations*
  The demographic insights on HCV care linkage underscore the importance of targeted interventions to address the nuanced needs of diverse populations. Strengthening care pathways for older adults, enhancing culturally appropriate support for ethnic minorities, and addressing gender-specific barriers to care are imperative for improving health outcomes. Public health strategies must continue to evolve, ensuring that every patient, irrespective of their demographic background, is seamlessly guided through the healthcare system from diagnosis to treatment.


#HBV
# Data Preparation and Cleaning
``` {r HBV-data-cleaning}
attendees_HBV <- attendees_HBV %>% 
  mutate(IMD = if_else(
    is.na(IMD), 
    "Unknown IMD", 
    IMD, 
    IMD),
    Gender = if_else( # Replace Sex with Gender
      is.na(Sex), 
      "Unknown Gender", 
      Sex, 
      Sex),
    ethnic_group = if_else(
      (is.na(ethnic_group) |
         ethnic_group == "Unknown"), 
      "Unknown Ethnicity", 
      ethnic_group,
      ethnic_group)) %>% 
  mutate(All = case_when(age >= 0 ~ "All")) %>%
  mutate(Gender = replace(Gender, Gender=="FEMALE", "Women")) %>% # Replace Female
  mutate(Gender = replace(Gender, Gender=="MALE", "Men")) %>%    # Replace Male
  mutate(age_group = str_replace_all(age_group, "-", " to "),
         age_group = str_replace_all(age_group, "80\\+", "80 and over"),
         age_group = str_replace_all(age_group, "(\\d+)(to)(\\d+)", "\\1 to \\3")) %>%
  mutate(age_group = ifelse(age_group == "16 to 24" & is.na(age_group), "0", age_group))

```  
# Characteristics of Attendees in the 5 included sites for HBV
``` {r HBV-xteristics1}
attendees_HBV_1 <- attendees_HBV %>% 
  mutate(
    IMD = if_else(is.na(IMD), "Unknown IMD", as.character(IMD)),
    Gender = if_else(is.na(Sex), "Unknown Gender", as.character(Sex)),
    ethnic_group = if_else(is.na(ethnic_group) | ethnic_group == "Unknown", 
                           "Unknown Ethnicity", as.character(ethnic_group)),
    Gender = case_when(
      Gender == "FEMALE" ~ "Women",
      Gender == "MALE" ~ "Men",
      TRUE ~ Gender
    ),
    age_group = case_when(
      age >= 0 & age <= 24 ~ "16 to 24",
      age >= 25 & age <= 34 ~ "25 to 34",
      age >= 35 & age <= 49 ~ "35 to 49",
      age >= 50 & age <= 64 ~ "50 to 64",
      age >= 65 & age <= 79 ~ "65 to 79",
      age >= 80 ~ "80 and over",
      TRUE ~ "Unknown Age Group"
    )
  ) %>%
  group_by(age_group, Gender, IMD, ethnic_group) %>%
  summarise(Total_Attendees = n(), .groups = 'drop')
# View the first few rows of the processed dataset
head(attendees_HBV_1)
```

# Visualisation 1: Bar Plot of Total Attendees by Age Group
``` {r HBV-xteristics2}
ggplot(attendees_HBV_1, aes(x = age_group, y = Total_Attendees, fill = age_group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HBV Attendees by Age Group",
       x = "Age Group",
       y = "Total Attendees")
```       
# Visualisation 2: Bar Plot of Total Attendees by Gender
``` {r HBV-xteristics3}
attendees_HBV_1 <- attendees_HBV_1 %>% 
  filter(Gender != "Unknown Gender")

ggplot(attendees_HBV_1, aes(x = Gender, y = Total_Attendees, fill = Gender)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HBV Attendees by Gender",
       x = "Gender",
       y = "Total Attendees")
```

# Visualisation 3: Bar Plot of Total Attendees by Ethnic Group
``` {r HBV-xteristics4}
attendees_HBV_1 <- attendees_HBV_1 %>% 
  filter(ethnic_group != "Unknown Ethnicity", ethnic_group != "Other")

ggplot(attendees_HBV_1, aes(x = ethnic_group, y = Total_Attendees, fill = ethnic_group)) +
  geom_bar(stat = "identity") + 
  coord_flip() + 
  theme_minimal() +
  labs(title = "HBV Attendees by Ethnic Group",
       x = "Ethnic Group",
       y = "Total Attendees")
```       
# Visualisation 4: Bar Plot of Total Attendees by IMD
``` {r HBV-xteristics5}
attendees_HBV_1 <- attendees_HBV_1 %>% 
  filter(IMD != "Unknown IMD")

ggplot(attendees_HBV_1, aes(x = IMD, y = Total_Attendees, fill = IMD)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "HBV Attendees by IMD",
       x = "Index of Multiple Deprivation (IMD)",
       y = "Total Attendees")
```
# Reshaping the data for a combined plot of all demographic groups
``` {r HBV-xteristics6}
attendees_long_HBV <- attendees_HBV_1 %>%
  pivot_longer(cols = -Total_Attendees, names_to = "Demographic", values_to = "Category")

# Drop NA values and unwanted categories before plotting
attendees_long_HBV <- attendees_long_HBV %>%
  filter(!is.na(Category)) %>%
  filter(!(Category %in% c("Unknown Gender", "Unknown IMD")))

# Reorder the factors within each demographic subgroup
attendees_long_HBV <- attendees_long_HBV %>%
  mutate(Category = case_when(
    Demographic == "age_group" ~ fct_relevel(Category, 
                                             "16 to 24", "25 to 34", "35 to 49", "50 to 64", 
                                             "65 to 79", "80 and over"),
    Demographic == "ethnic_group" ~ fct_reorder(Category, as.numeric(as.factor(Category))),
    TRUE ~ fct_reorder(Category, Total_Attendees)
  ))

# Improved Visualization without headers for each demographic subgroup
ggplot(attendees_long_HBV, aes(x = Category, y = Total_Attendees)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +  # Set uniform bar color
  coord_flip() +  # Flip coordinates to make horizontal bar chart
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),  # Remove y-axis title for cleaner look
    axis.text.y = element_text(size = 10),  # Adjust text size for better readability
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),  # Center the plot title
    strip.text.x = element_blank(),  # Remove the text for facet labels
    strip.background = element_blank(),  # Remove background for facet labels
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),  # Lighter grid lines
    panel.grid.major.y = element_blank(),  # No horizontal grid lines
    panel.spacing = unit(1, "lines")  # Increase spacing between facets
  ) +
  labs(
    title = "Demographic Characteristics of Attendees with a HBV Blood Test",
    x = "Total Attendees",
    y = ""  # Since we're flipping the coordinates, x and y axis labels are swapped
  ) +
  facet_wrap(~ Demographic, scales = "free_y", ncol = 1)  # Facet by Demographic

# Run the plot

```

*Overview*
  The demographic characteristics of attendees of Hepatitis B Virus (HBV) testing within the Emergency Department Bloodborne Virus Opt-Out Programme in the 5 sentinel sites reveal significant insights into the programme's reach and effectiveness across diverse population segments.

*Age Group Trends in HBV Testing*
HBV testing participation peaks in the 35 to 49 age group, suggesting heightened awareness or risk perception in this demographic. The lower testing numbers in the youngest (16 to 24) and oldest (65 and over) groups highlight potential gaps in awareness or accessibility, indicating a need for age-specific outreach strategies.

*Ethnic Diversity and Testing Engagement*
The ethnic breakdown reveals a wide engagement across various groups, with significant numbers in White British and Indian, Pakistani, or Bangladeshi communities. However, the data also point to lower testing rates in some minority groups like Black Caribbean and Mixed/Multiple ethnicities. This underscores the need for culturally-sensitive health communication to ensure equitable testing coverage across all ethnic groups.

*Gender Dynamics in HBV Testing*
The programme sees slightly more women than men getting tested for HBV, reflecting effective outreach among female attendees. However, the close gender parity in testing also suggests that health messages and services are resonating across gender lines, a positive sign for public health initiatives.

*Socioeconomic Patterns*
Testing distribution across socioeconomic strata shows a fairly even spread, with a slight decrease in testing in the least deprived areas (Quintile 5). This indicates that the programme is successfully reaching a diverse socioeconomic audience, but continuous efforts are required to maintain equitable access.

*Public Health Implications*
The demographic insights provide key indications for tailoring public health strategies. Age-focused health education, culturally tailored interventions, and gender-responsive communication are essential to ensure comprehensive HBV testing coverage. Additionally, consistent efforts in data collection and analysis are crucial for understanding and addressing health disparities in HBV testing and care.


#Proportion of Attendees in the 5 included sites Tested for HBV by Demographics

# Proportion of Attendees tested by age_group
``` {r HBV-prop1}
proportion_tested_by_age_HBV <- attendees_HBV %>%
  group_by(age_group) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_age_HBV)
```
# Visualisation of Proportion Tested by Age Group
``` {r HBV-prop2}
ggplot(proportion_tested_by_age_HBV, aes(x = age_group, y = Proportion_Tested, fill = age_group)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HBV Tested Attendees by Age Group",
    x = "Age Group",
    y = "Proportion Tested"
  )
```

# Proportion of Attendees tested by Gender
``` {r HBV-prop3}
proportion_tested_by_gender_HBV <- attendees_HBV %>%
  group_by(Gender) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_gender_HBV)
```
# Visualisation of Proportion Tested by Gender
``` {r HBV-prop4}
proportion_tested_by_gender_HBV <- proportion_tested_by_gender_HBV %>% 
  filter(Gender != "Unknown Gender")

ggplot(proportion_tested_by_gender_HBV, aes(x = Gender, y = Proportion_Tested, fill = Gender)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Proportion of HBV Tested Attendees by Gender",
    x = "Gender",
    y = "Proportion Tested"
  )
```

# Proportion of Attendees tested by Ethnic Group
``` {r HBV-prop5}
proportion_tested_by_ethnic_group_HBV <- attendees_HBV %>%
  group_by(ethnic_group) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_ethnic_group_HBV)
```
# Visualisation of Proportion Tested by Ethnic Group
``` {r HBV-prop6}
proportion_tested_by_ethnic_group_HBV <- proportion_tested_by_ethnic_group_HBV %>% 
  filter(ethnic_group != "Unknown Ethnicity", ethnic_group != "Other")

ggplot(proportion_tested_by_ethnic_group_HBV, aes(x = ethnic_group, y = Proportion_Tested, fill = ethnic_group)) +
  geom_col() +
  coord_flip() + 
  theme_minimal() +
  labs(
    title = "Proportion of HBV Tested Attendees by Ethnic Group",
    x = "Ethnic Group",
    y = "Proportion Tested"
  )
```
# Proportion of Attendees tested by IMD
``` {r HBV-prop7}
proportion_tested_by_IMD_HBV <- attendees_HBV %>%
  group_by(IMD) %>%
  summarise(
    Total_Attendees = n(),
    Tested_Attendees = sum(ECDS_bloods_any == "Yes", na.rm = TRUE),
    Proportion_Tested = Tested_Attendees / Total_Attendees
  ) %>%
  ungroup()

# View the calculated proportions

print(proportion_tested_by_IMD_HBV)
```
# Visualisation of Proportion Tested by IMD
``` {r HBV-prop8}
proportion_tested_by_IMD_HBV <- proportion_tested_by_IMD_HBV %>% 
  filter(IMD != "Unknown IMD")

ggplot(proportion_tested_by_IMD_HBV, aes(x = IMD, y = Proportion_Tested, fill = IMD)) + 
  geom_col() + 
  theme_minimal() + 
  labs(
    title = "Proportion of HBV Tested Attendees by IMD",
    x = "IMD",
    y = "Proportion Tested"
  )
```  
# Combine proportion data frames with for an improved visualisation of all demographic groups
``` {rHBV-prop9}
combined_proportions_HBV <- bind_rows(
  mutate(proportion_tested_by_age_HBV, Demographic = "Age Group"),
  mutate(proportion_tested_by_gender_HBV, Demographic = "Gender"),
  mutate(proportion_tested_by_ethnic_group_HBV, Demographic = "Ethnic Group"),
  mutate(proportion_tested_by_IMD_HBV, Demographic = "IMD")
) 

# Pivot only the demographic category columns
combined_proportions_long_HBV <- combined_proportions_HBV %>%
  pivot_longer(cols = c(age_group, Gender, ethnic_group, IMD), 
               names_to = "Category", values_to = "Category_Value", 
               values_drop_na = TRUE) %>%
  filter(!(Category_Value %in% c("Unknown Gender", "Unknown IMD"))) %>%
  select(-Total_Attendees, -Tested_Attendees)  # Remove unnecessary columns

# Improved Visualization
ggplot(combined_proportions_long_HBV, aes(x = Category_Value, y = Proportion_Tested)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    strip.text.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Proportion of Attendees Tested for HBV by Demographics",
    x = "Demographic Category",
    y = "Proportion Tested (%)"
  ) +
  facet_wrap(~ Category, scales = "free_y", ncol = 1)
  
# Run the plot
```

# Percentage of attendees Diagnosed with HBV by Demographics
#Additional HBV Data loading and cleaning
``` {r HBV-diag1}
attendees_HBVnew <- attendees_HBV %>% filter(HBsAg_positive_new == "New") %>% 
  mutate(IMD = if_else(
    is.na(IMD), 
    "Unknown IMD", 
    IMD, 
    IMD),
    Gender = if_else( # Replace Sex with Gender
      is.na(Sex), 
      "Unknown Gender", 
      Sex, 
      Sex),
    ethnic_group = if_else(
      (is.na(ethnic_group) |
         ethnic_group == "Unknown"), 
      "Unknown Ethnicity", 
      ethnic_group,
      ethnic_group)) %>% 
  mutate(All = case_when(age >= 0 ~ "All")) %>%
  mutate(Gender = replace(Gender, Gender=="FEMALE", "Women")) %>% # Replace Female
  mutate(Gender = replace(Gender, Gender=="MALE", "Men")) %>%    # Replace Male
  mutate(age_group = str_replace_all(age_group, "-", " to "),
         age_group = str_replace_all(age_group, "80\\+", "80 and over"),
         age_group = str_replace_all(age_group, "(\\d+)(to)(\\d+)", "\\1 to \\3")) %>%
  mutate(age_group = ifelse(age_group == "16 to 24" & is.na(age_group), "0", age_group))
```
# Percentage Diagnosed by Age group
``` {r HBV-diag2}
percentage_diagnosed_by_age_HBV <- attendees_HBVnew %>%
  group_by(age_group) %>% 
                        summarise(Count = n()) %>% 
                        mutate(Percentage = Count / sum(Count) * 100)
```
# Visualisation of Percentage Diagnosed by Age group
``` {r HBV-diag3}
ggplot(percentage_diagnosed_by_age_HBV, aes(x = age_group, y = Percentage, fill = age_group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Percentage of Diagnosed HBV Patients by Age Group", x = "Age Group", y = "Percentage")
```
# Percentage Diagnosed by Gender
``` {r HBV-diag4}
percentage_diagnosed_by_gender_HBV <- attendees_HBVnew %>% 
                  group_by(Gender) %>% 
                  summarise(Count = n()) %>% 
                  mutate(Percentage = Count / sum(Count) * 100)
```
# Visualisation of Percentage Diagnosed by Gender
``` {r HBV-diag5}
ggplot(percentage_diagnosed_by_gender_HBV, aes(x = Gender, y = Percentage, fill = Gender)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Percentage of Diagnosed HBV Patients by Gender", x = "Gender", y = "Percentage")
```       
# Percentage Diagnosed by IMD
``` {r HBV-diag6}
percentage_diagnosed_by_IMD_HBV <- attendees_HBVnew %>% 
                  group_by(IMD) %>% 
                  summarise(Count = n()) %>% 
                  mutate(Percentage = Count / sum(Count) * 100)
```
# Visualisation of Percentage Diagnosed by IMD
``` {r HBV-diag7}
percentage_diagnosed_by_IMD_HBV <- percentage_diagnosed_by_IMD_HBV %>% 
  filter(IMD != "Unknown IMD")

ggplot(percentage_diagnosed_by_IMD_HBV, aes(x = IMD, y = Percentage, fill = IMD)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Percentage of Diagnosed HBV Patients by IMD", x = "IMD", y = "Percentage")
```
# Percentage Diagnosed by Ethnic Group
``` {r HBV-diag8}
percentage_diagnosed_by_Ethnic_Group_HBV <- attendees_HBVnew %>% 
                           group_by(ethnic_group) %>% 
                           summarise(Count = n()) %>% 
                           mutate(Percentage = Count / sum(Count) * 100)
```
# Visualisation of Percentage Diagnosed by Ethnic Group
``` {r HBV-diag9}
percentage_diagnosed_by_Ethnic_Group_HBV <- percentage_diagnosed_by_Ethnic_Group_HBV %>% 
  filter(ethnic_group != "Unknown Ethnicity", ethnic_group != "Other")

ggplot(percentage_diagnosed_by_Ethnic_Group_HBV, aes(x = ethnic_group, y = Percentage, fill = ethnic_group)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  coord_flip() + # For better readability of ethnic group names
  labs(title = "Percentage of Diagnosed HBV Patients by Ethnic Group", x = "Ethnic Group", y = "Percentage")
```
# Combine the percentage diagnosed data frames for improved visualisation of all demographic groups
``` {r HBV-diag10}
# Reshape and combine all demographic data frames
combined_percentage_diagnosed_long_HBV <- bind_rows(
  percentage_diagnosed_by_age_HBV %>% mutate(Demographic = "Age Group") %>% rename(Category_Value = age_group),
  percentage_diagnosed_by_gender_HBV %>% mutate(Demographic = "Gender") %>% rename(Category_Value = Gender),
  percentage_diagnosed_by_IMD_HBV %>% mutate(Demographic = "IMD") %>% rename(Category_Value = IMD),
  percentage_diagnosed_by_Ethnic_Group_HBV %>% mutate(Demographic = "Ethnic Group") %>% rename(Category_Value = ethnic_group)
) %>% 
  select(Demographic, Category_Value, Percentage = Percentage)

# Improved Visualisation
ggplot(combined_percentage_diagnosed_long_HBV, aes(x = Category_Value, y = Percentage)) +
  geom_bar(stat = "identity", fill = "darkblue", show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    strip.text.x = element_blank(),
    strip.background = element_blank(),
    panel.grid.major.x = element_line(size = 0.5, color = "grey"),
    panel.grid.major.y = element_blank(),
    panel.spacing = unit(1, "lines")
  ) +
  labs(
    title = "Percentage Diagnosed with HBV by Demographics",
    x = "Demographic Category",
    y = "Percentage Diagnosed (%)"
  ) +
  facet_wrap(~ Demographic, scales = "free_y", ncol = 1)


# Run the plot
```
*Overview*
This report delves into the demographic breakdown of Hepatitis B Virus (HBV) diagnoses within the Emergency Department Bloodborne Virus Opt-Out Testing Programme, offering key insights into the patterns of HBV incidence across various population groups.

*Age Group Analysis*
A significant portion of HBV diagnoses is concentrated in the 35 to 64 age range, with the highest in the 35 to 49 bracket. This prevalence suggests a higher risk or greater exposure to HBV in these middle-aged groups, potentially due to lifestyle factors or historical exposure. The relatively lower diagnosis rates in the youngest (16 to 24) and oldest (over 65) cohorts might reflect lower exposure risk or differences in testing uptake.

*Ethnicity and HBV Diagnoses*
Ethnicity plays a crucial role in the diagnosis rates, with the highest percentages seen in Black African and White Other groups. The elevated rate in Black African individuals could be linked to higher HBV prevalence in certain African countries and the likelihood of transmission during infancy or childhood. The significant percentage in the White Other category might indicate varied exposure risks, including immigration from regions with higher HBV prevalence. Lower diagnosis rates in other ethnic groups, such as White British and Mixed/Multiple ethnicities, highlight the need for targeted public health strategies to enhance testing and diagnosis in these populations.

*Gender Disparity in Diagnoses*
Men have a higher percentage of HBV diagnoses compared to women. This disparity could be attributed to behavioral factors, occupational exposure, or different patterns of healthcare utilization between genders. It underscores the importance of gender-sensitive health promotion and targeted interventions to increase awareness and testing among both men and women.

*Socioeconomic Influence*
Diagnosis rates across different socioeconomic groups (as indicated by IMD quintiles) show a relatively even distribution, with a slightly higher rate in the second quintile. This suggests that while socioeconomic factors play a role in HBV exposure and diagnosis, the programme has been fairly successful in reaching a diverse demographic.

*Public Health Implications*
The demographic data points to the need for multifaceted and culturally sensitive public health interventions. Efforts must be concentrated on increasing awareness and testing in middle-aged populations, addressing specific risks and health behaviors in men, and tailoring strategies to engage various ethnic communities effectively. Moreover, maintaining equitable healthcare access across all socioeconomic backgrounds is crucial for controlling HBV spread and ensuring prompt linkage to care 
